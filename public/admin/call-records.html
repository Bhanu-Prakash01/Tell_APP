<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Call Records - Admin Panel</title>
	<link rel="stylesheet" href="../assets/frappe.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<style>
		:root {
			--sidebar-width: 280px;
			--header-height: 70px;
			--transition-speed: 0.3s;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: var(--fr-bg);
			color: var(--fr-text);
			overflow-x: hidden;
		}

		/* Layout Structure */
		.admin-layout {
			display: flex;
			min-height: 100vh;
		}

		/* Sidebar */
		.admin-sidebar {
			width: var(--sidebar-width);
			background: linear-gradient(180deg, #1a1d29 0%, #0f1419 100%);
			color: #e2e8f0;
			position: fixed;
			left: 0;
			top: 0;
			height: 100vh;
			z-index: 1000;
			border-right: 1px solid rgba(255, 255, 255, 0.1);
			overflow-y: auto;
		}

		.sidebar-header {
			padding: 24px 20px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
		}

		.sidebar-header h1 {
			font-size: 20px;
			font-weight: 700;
			color: #ffffff;
			margin: 0;
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.sidebar-header h1 i {
			color: var(--fr-primary);
			font-size: 24px;
		}

		.sidebar-nav {
			padding: 20px 0;
		}

		.nav-section-title {
			padding: 8px 20px;
			font-size: 11px;
			font-weight: 700;
			color: #64748b;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin-top: 16px;
		}

		.nav-item {
			display: flex;
			align-items: center;
			gap: 12px;
			padding: 12px 20px;
			color: #94a3b8;
			text-decoration: none;
			transition: all 0.2s ease;
			border-left: 3px solid transparent;
			font-size: 14px;
			font-weight: 500;
		}

		.nav-item:hover {
			background: rgba(94, 100, 255, 0.1);
			color: #ffffff;
			border-left-color: var(--fr-primary);
		}

		.nav-item.active {
			background: rgba(94, 100, 255, 0.15);
			color: #ffffff;
			border-left-color: var(--fr-primary);
		}

		.nav-item i {
			width: 20px;
			font-size: 16px;
			text-align: center;
		}

		/* Main Content */
		.main-content {
			flex: 1;
			margin-left: var(--sidebar-width);
			background: var(--fr-bg);
		}

		/* Header */
		.page-header {
			background: var(--fr-surface);
			border-bottom: 1px solid var(--fr-border);
			padding: 20px 32px;
			position: sticky;
			top: 0;
			z-index: 100;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
		}

		.header-top {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 16px;
		}

		.page-title {
			font-size: 28px;
			font-weight: 700;
			color: var(--fr-text);
			margin: 0;
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.page-title i {
			color: var(--fr-primary);
		}

		.header-actions {
			display: flex;
			gap: 12px;
			align-items: center;
		}

		.breadcrumb {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 13px;
			color: var(--fr-muted);
		}

		.breadcrumb-separator {
			color: var(--fr-border);
		}

		/* Content Area */
		.content-area {
			padding: 32px;
			max-width: 1800px;
			margin: 0 auto;
		}

		/* Stats Cards */
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
			gap: 20px;
			margin-bottom: 32px;
		}

		.stat-card {
			background: var(--fr-surface);
			border: 1px solid var(--fr-border);
			border-radius: 12px;
			padding: 24px;
			transition: all 0.2s ease;
			position: relative;
			overflow: hidden;
		}

		.stat-card::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 4px;
			background: linear-gradient(90deg, var(--fr-primary), var(--fr-primary-600));
		}

		.stat-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
			border-color: var(--fr-primary);
		}

		.stat-icon {
			width: 48px;
			height: 48px;
			border-radius: 12px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 22px;
			color: white;
			margin-bottom: 16px;
		}

		.stat-icon.primary { background: var(--fr-primary); }
		.stat-icon.success { background: var(--fr-green); }
		.stat-icon.warning { background: var(--fr-orange); }
		.stat-icon.info { background: #3b82f6; }

		.stat-value {
			font-size: 32px;
			font-weight: 700;
			color: var(--fr-text);
			line-height: 1;
			margin-bottom: 8px;
		}

		.stat-label {
			font-size: 13px;
			color: var(--fr-muted);
			font-weight: 500;
		}

		/* Main Grid */
		.main-grid {
			display: grid;
			grid-template-columns: 320px 1fr;
			gap: 24px;
			align-items: start;
		}

		/* Filter Panel */
		.filter-panel {
			background: var(--fr-surface);
			border: 1px solid var(--fr-border);
			border-radius: 12px;
			padding: 24px;
			position: sticky;
			top: 100px;
		}

		.filter-panel h3 {
			font-size: 16px;
			font-weight: 600;
			color: var(--fr-text);
			margin: 0 0 20px 0;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.filter-panel h3 i {
			color: var(--fr-primary);
		}

		.filter-group {
			margin-bottom: 20px;
		}

		.filter-group:last-child {
			margin-bottom: 0;
		}

		.filter-label {
			display: block;
			font-size: 13px;
			font-weight: 600;
			color: var(--fr-text);
			margin-bottom: 8px;
		}

		.filter-input,
		.filter-select {
			width: 100%;
			padding: 10px 14px;
			border: 1px solid var(--fr-border);
			border-radius: 8px;
			background: var(--fr-bg);
			font-size: 14px;
			color: var(--fr-text);
			transition: all 0.2s ease;
		}

		.filter-input:focus,
		.filter-select:focus {
			outline: none;
			border-color: var(--fr-primary);
			box-shadow: 0 0 0 3px rgba(94, 100, 255, 0.1);
		}

		.filter-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 12px;
		}

		.checkbox-label {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 14px;
			color: var(--fr-text);
			cursor: pointer;
		}

		.checkbox-label input[type="checkbox"] {
			width: 18px;
			height: 18px;
			cursor: pointer;
		}

		.filter-actions {
			display: flex;
			gap: 10px;
			margin-top: 20px;
		}

		/* Data Panel */
		.data-panel {
			background: var(--fr-surface);
			border: 1px solid var(--fr-border);
			border-radius: 12px;
			overflow: hidden;
		}

		.data-panel-header {
			padding: 20px 24px;
			border-bottom: 1px solid var(--fr-border);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.data-count {
			font-size: 14px;
			color: var(--fr-muted);
		}

		.data-count strong {
			color: var(--fr-text);
			font-weight: 600;
		}

		/* Table */
		.table-wrapper {
			overflow-x: auto;
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
			background: var(--fr-surface);
		}

		.data-table thead {
			background: var(--fr-bg);
			border-bottom: 2px solid var(--fr-border);
		}

		.data-table th {
			padding: 16px 20px;
			text-align: left;
			font-size: 12px;
			font-weight: 700;
			color: var(--fr-text);
			text-transform: uppercase;
			letter-spacing: 0.5px;
			white-space: nowrap;
		}

		.data-table td {
			padding: 16px 20px;
			border-bottom: 1px solid var(--fr-border);
			font-size: 14px;
			color: var(--fr-text);
		}

		.data-table tbody tr {
			transition: background 0.15s ease;
		}

		.data-table tbody tr:hover {
			background: var(--fr-bg);
		}

		.data-table tbody tr:last-child td {
			border-bottom: none;
		}

		/* Lead Cell */
		.lead-cell {
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.lead-avatar {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			background: var(--fr-primary);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-weight: 700;
			font-size: 14px;
			flex-shrink: 0;
		}

		.lead-info {
			flex: 1;
			min-width: 0;
		}

		.lead-name {
			font-weight: 600;
			color: var(--fr-text);
			margin-bottom: 4px;
		}

		.lead-email {
			font-size: 12px;
			color: var(--fr-muted);
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		/* Badges */
		.badge {
			display: inline-flex;
			align-items: center;
			padding: 4px 12px;
			border-radius: 6px;
			font-size: 12px;
			font-weight: 600;
			text-transform: capitalize;
		}

		.badge-completed { background: #dcfce7; color: #166534; }
		.badge-missed { background: #fee2e2; color: #991b1b; }
		.badge-declined { background: #fef3c7; color: #92400e; }
		.badge-not_lifted { background: #e0e7ff; color: #3730a3; }
		.badge-busy { background: #fecaca; color: #7f1d1d; }
		.badge-unreachable { background: #f3e8ff; color: #6b21a8; }
		.badge-voicemail { background: #dbeafe; color: #1e40af; }

		/* Buttons */
		.btn {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			padding: 10px 18px;
			border-radius: 8px;
			border: 1px solid transparent;
			font-weight: 500;
			font-size: 14px;
			cursor: pointer;
			transition: all 0.2s ease;
			text-decoration: none;
			white-space: nowrap;
		}

		.btn-primary {
			background: var(--fr-primary);
			color: white;
			border-color: var(--fr-primary);
		}

		.btn-primary:hover {
			background: var(--fr-primary-600);
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(94, 100, 255, 0.3);
		}

		.btn-outline {
			background: transparent;
			color: var(--fr-text);
			border-color: var(--fr-border);
		}

		.btn-outline:hover {
			background: var(--fr-bg);
			border-color: var(--fr-primary);
			color: var(--fr-primary);
		}

		.btn-success {
			background: var(--fr-green);
			color: white;
			border-color: var(--fr-green);
		}

		.btn-success:hover {
			background: #22c55e;
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
		}

		.btn-sm {
			padding: 6px 12px;
			font-size: 13px;
		}

		.btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.btn-group {
			display: flex;
			gap: 8px;
			flex-wrap: wrap;
		}

		/* Pagination */
		.pagination {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 20px 24px;
			border-top: 1px solid var(--fr-border);
		}

		.pagination-controls {
			display: flex;
			gap: 10px;
		}

		.pagination-info {
			font-size: 14px;
			color: var(--fr-muted);
		}

		/* Modal */
		.modal {
			display: none;
			position: fixed;
			inset: 0;
			background: rgba(0, 0, 0, 0.6);
			z-index: 2000;
			align-items: center;
			justify-content: center;
			padding: 20px;
			animation: fadeIn 0.2s ease;
		}

		.modal.show {
			display: flex;
		}

		@keyframes fadeIn {
			from { opacity: 0; }
			to { opacity: 1; }
		}

		.modal-content {
			background: var(--fr-surface);
			border: 1px solid var(--fr-border);
			border-radius: 16px;
			width: 100%;
			max-width: 900px;
			max-height: 90vh;
			overflow: hidden;
			box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
			animation: slideUp 0.3s ease;
		}

		@keyframes slideUp {
			from { transform: translateY(30px); opacity: 0; }
			to { transform: translateY(0); opacity: 1; }
		}

		.modal-header {
			padding: 24px 28px;
			border-bottom: 1px solid var(--fr-border);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.modal-title {
			font-size: 20px;
			font-weight: 700;
			color: var(--fr-text);
			margin: 0;
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.modal-title i {
			color: var(--fr-primary);
		}

		.modal-body {
			padding: 28px;
			max-height: calc(90vh - 120px);
			overflow-y: auto;
		}

		.detail-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
			gap: 24px;
			margin-bottom: 24px;
		}

		.detail-card {
			background: var(--fr-bg);
			border: 1px solid var(--fr-border);
			border-radius: 12px;
			padding: 20px;
		}

		.detail-card h4 {
			font-size: 14px;
			font-weight: 700;
			color: var(--fr-text);
			margin: 0 0 16px 0;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		.detail-item {
			display: flex;
			justify-content: space-between;
			align-items: start;
			padding: 12px 0;
			border-bottom: 1px solid var(--fr-border);
		}

		.detail-item:last-child {
			border-bottom: none;
		}

		.detail-label {
			font-size: 13px;
			color: var(--fr-muted);
			font-weight: 500;
		}

		.detail-value {
			font-size: 14px;
			color: var(--fr-text);
			font-weight: 600;
			text-align: right;
		}

		.audio-player {
			width: 100%;
			height: 48px;
			border-radius: 8px;
			margin-bottom: 16px;
		}

		.playback-controls {
			display: flex;
			gap: 12px;
			align-items: center;
		}

		.notes-box {
			background: var(--fr-bg);
			border: 1px solid var(--fr-border);
			border-radius: 12px;
			padding: 20px;
		}

		.notes-box h4 {
			font-size: 14px;
			font-weight: 700;
			color: var(--fr-text);
			margin: 0 0 12px 0;
		}

		.notes-content {
			color: var(--fr-text);
			line-height: 1.6;
			font-size: 14px;
		}

		.empty-state {
			text-align: center;
			padding: 60px 20px;
			color: var(--fr-muted);
		}

		.empty-state i {
			font-size: 64px;
			margin-bottom: 20px;
			opacity: 0.3;
		}

		.empty-state h3 {
			margin: 0 0 8px 0;
			color: var(--fr-text);
			font-size: 18px;
		}

		.empty-state p {
			margin: 0;
			font-size: 14px;
		}

		/* Responsive */
		@media (max-width: 1200px) {
			.main-grid {
				grid-template-columns: 1fr;
			}

			.filter-panel {
				position: static;
			}

			.stats-grid {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		@media (max-width: 768px) {
			.admin-sidebar {
				transform: translateX(-100%);
			}

			.main-content {
				margin-left: 0;
			}

			.content-area {
				padding: 20px;
			}

			.page-header {
				padding: 16px 20px;
			}

			.stats-grid {
				grid-template-columns: 1fr;
			}

			.filter-grid {
				grid-template-columns: 1fr;
			}

			.header-actions {
				flex-direction: column;
				gap: 8px;
			}
		}
	</style>
</head>
<body>
	<div class="admin-layout">
		<!-- Sidebar -->
		<aside class="admin-sidebar">
			<div class="sidebar-header">
				<h1><i class="fas fa-phone-alt"></i> TeleCRM Admin</h1>
			</div>
			<nav class="sidebar-nav">
				<div class="nav-section-title">Main</div>
				<a href="/admin/overview.html" class="nav-item">
					<i class="fas fa-chart-line"></i>
					<span>Overview</span>
				</a>
				<a href="/admin/users.html" class="nav-item">
					<i class="fas fa-users"></i>
					<span>Users</span>
				</a>
				<a href="/admin/leads.html" class="nav-item">
					<i class="fas fa-address-book"></i>
					<span>Leads</span>
				</a>
				<a href="/admin/call-records.html" class="nav-item active">
					<i class="fas fa-phone-volume"></i>
					<span>Call Records</span>
				</a>
				<div class="nav-section-title">System</div>
				<a href="/admin/settings.html" class="nav-item">
					<i class="fas fa-cog"></i>
					<span>Settings</span>
				</a>
				<a href="/admin/mailbox.html" class="nav-item">
					<i class="fas fa-envelope"></i>
					<span>Mailbox</span>
				</a>
			</nav>
		</aside>

		<!-- Main Content -->
		<main class="main-content">
			<!-- Page Header -->
			<div class="page-header">
				<div class="header-top">
					<div>
						<h1 class="page-title">
							<i class="fas fa-phone-volume"></i>
							Call Records
						</h1>
						<div class="breadcrumb">
							<span>Admin Panel</span>
							<span class="breadcrumb-separator">/</span>
							<span>Call Records</span>
						</div>
					</div>
					<div class="header-actions">
						<button class="btn btn-outline btn-sm" id="themeToggle">
							<i class="fas fa-moon"></i>
							<span>Theme</span>
						</button>
						<button class="btn btn-success btn-sm" id="btnRefresh">
							<i class="fas fa-sync-alt"></i>
							<span>Refresh</span>
						</button>
						<a class="btn btn-outline btn-sm" href="/login.html" onclick="logout(event)">
							<i class="fas fa-sign-out-alt"></i>
							<span>Logout</span>
						</a>
					</div>
				</div>
			</div>

			<!-- Content Area -->
			<div class="content-area">
				<!-- Stats Grid -->
				<div class="stats-grid">
					<div class="stat-card">
						<div class="stat-icon primary">
							<i class="fas fa-phone"></i>
						</div>
						<div class="stat-value" id="totalCalls">0</div>
						<div class="stat-label">Total Calls</div>
					</div>
					<div class="stat-card">
						<div class="stat-icon success">
							<i class="fas fa-microphone"></i>
						</div>
						<div class="stat-value" id="recordedCalls">0</div>
						<div class="stat-label">With Recordings</div>
					</div>
					<div class="stat-card">
						<div class="stat-icon warning">
							<i class="fas fa-clock"></i>
						</div>
						<div class="stat-value" id="avgDuration">0m</div>
						<div class="stat-label">Avg Duration</div>
					</div>
					<div class="stat-card">
						<div class="stat-icon info">
							<i class="fas fa-calendar-day"></i>
						</div>
						<div class="stat-value" id="todayCalls">0</div>
						<div class="stat-label">Today's Calls</div>
					</div>
				</div>

				<!-- Main Grid -->
				<div class="main-grid">
					<!-- Filter Panel -->
					<div class="filter-panel">
						<h3><i class="fas fa-filter"></i> Filters</h3>

						<div class="filter-group">
							<label class="filter-label">Search</label>
							<input class="filter-input" id="search" type="text" placeholder="Lead name, phone, employee...">
						</div>

						<div class="filter-group">
							<label class="filter-label">Call Status</label>
							<select class="filter-select" id="filterStatus">
								<option value="">All Statuses</option>
								<option value="completed">Completed</option>
								<option value="missed">Missed</option>
								<option value="declined">Declined</option>
								<option value="not_lifted">Not Lifted</option>
								<option value="busy">Busy</option>
								<option value="unreachable">Unreachable</option>
								<option value="voicemail">Voicemail</option>
							</select>
						</div>

						<div class="filter-group">
							<label class="filter-label">Employee</label>
							<select class="filter-select" id="filterEmployee">
								<option value="">All Employees</option>
							</select>
						</div>

						<div class="filter-group">
							<div class="filter-grid">
								<div>
									<label class="filter-label">Date From</label>
									<input class="filter-input" type="date" id="dateFrom">
								</div>
								<div>
									<label class="filter-label">Date To</label>
									<input class="filter-input" type="date" id="dateTo">
								</div>
							</div>
						</div>

						<div class="filter-group">
							<label class="checkbox-label">
								<input type="checkbox" id="filterHasRecording">
								<span>Has Recording Only</span>
							</label>
						</div>

						<div class="filter-actions">
							<button class="btn btn-primary" id="applyFiltersBtn" style="flex: 1;">
								<i class="fas fa-check"></i>
								Apply
							</button>
							<button class="btn btn-outline" id="resetFiltersBtn">
								<i class="fas fa-redo"></i>
							</button>
						</div>

						<div class="filter-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--fr-border);">
							<label class="filter-label">Items Per Page</label>
							<select class="filter-select" id="pageSize">
								<option value="10">10</option>
								<option value="25" selected>25</option>
								<option value="50">50</option>
								<option value="100">100</option>
							</select>
						</div>

						<div class="filter-group">
							<button class="btn btn-outline" id="autoBtn" style="width: 100%;">
								<i class="fas fa-sync"></i>
								Auto-Refresh (30s)
							</button>
						</div>
					</div>

					<!-- Data Panel -->
					<div class="data-panel">
						<div class="data-panel-header">
							<div class="data-count">
								Showing <strong id="count">0</strong> of <strong id="total">0</strong> records
							</div>
						</div>

						<div class="table-wrapper">
							<table class="data-table">
								<thead>
									<tr>
										<th>Lead</th>
										<th>Phone</th>
										<th>Employee</th>
										<th>Status</th>
										<th>Duration</th>
										<th>Date & Time</th>
										<th>Recording</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody id="recordsGrid"></tbody>
							</table>
						</div>

						<div class="pagination" id="paginationContainer" style="display: none;">
							<div class="pagination-controls">
								<button class="btn btn-outline btn-sm" id="prev">
									<i class="fas fa-chevron-left"></i>
									Previous
								</button>
								<button class="btn btn-outline btn-sm" id="next">
									Next
									<i class="fas fa-chevron-right"></i>
								</button>
							</div>
							<div class="pagination-info">
								Page <strong id="pageNum">1</strong>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>

	<!-- Call Details Modal -->
	<div id="callDetailsModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h3 class="modal-title">
					<i class="fas fa-info-circle"></i>
					Call Details
				</h3>
				<button class="btn btn-outline btn-sm" onclick="closeCallDetails()">
					<i class="fas fa-times"></i>
					Close
				</button>
			</div>
			<div class="modal-body" id="callDetailsContent"></div>
		</div>
	</div>

	<script src="../assets/admin.js"></script>
	<script>
		// Initialize
		Admin && Admin.navActivate && Admin.navActivate('/admin/call-records.html');

		// Theme Toggle
		(function(){
			const btn = document.getElementById('themeToggle');
			if(btn){
				btn.addEventListener('click', ()=>{
					const cur = localStorage.getItem('uiTheme') || 'light';
					const next = cur === 'light' ? 'semi' : (cur === 'semi' ? 'dark' : 'light');
					Admin.setTheme(next);
				});
			}
		})();

		// Logout
		function logout(e){
			e && e.preventDefault();
			try{
				localStorage.removeItem('token');
				localStorage.removeItem('role');
			}catch(_){}
			location.href = '/login.html';
		}

		// Global State
		let callRecords = [];
		let filteredRecords = [];
		let currentPage = 1;
		let pageSize = 25;
		let searchTerm = '';
		let autoRefreshInterval = null;
		let filterStatus = '';
		let filterEmployee = '';
		let filterHasRecording = false;
		let filterDateFrom = '';
		let filterDateTo = '';
		let employees = [];

		// Utility Functions
		function fmtDate(d){
			try{
				return new Date(d).toLocaleString('en-US', {
					year: 'numeric',
					month: 'short',
					day: 'numeric',
					hour: '2-digit',
					minute: '2-digit'
				});
			}catch(e){
				return '-';
			}
		}

		function fmtDuration(s){
			if(!s) return '0s';
			const m = Math.floor(s / 60);
			const sec = s % 60;
			return m ? `${m}m ${sec}s` : `${sec}s`;
		}

		// Update Stats
		function updateStats(){
			const total = callRecords.length;
			const rec = callRecords.filter(r => r.recordingFile || r.recordingUrl).length;
			const avg = total > 0 ? Math.round(callRecords.reduce((sum, r) => sum + (r.callDuration || 0), 0) / total / 60) : 0;
			const today = new Date().toDateString();
			const todayCount = callRecords.filter(r => new Date(r.callStartTime).toDateString() === today).length;

			document.getElementById('totalCalls').textContent = total;
			document.getElementById('recordedCalls').textContent = rec;
			document.getElementById('avgDuration').textContent = `${avg}m`;
			document.getElementById('todayCalls').textContent = todayCount;
		}

		// Load Call Records
		async function loadCallRecords(){
			try{
				const token = Admin.getToken();
				if(!token){
					alert('Please login first');
					return;
				}

				const res = await fetch('/api/admin/call-records', {
					headers: Admin.authHeaders()
				});

				if(!res.ok){
					const t = await res.text();
					alert('Failed to load: ' + t);
					return;
				}

				callRecords = await res.json();
				updateStats();
				applyFilters();
			}catch(e){
				console.error(e);
				alert('Error loading call records');
			}
		}

		// Load Employees
		async function loadEmployees(){
			try{
				const res = await fetch('/api/admin/employees', {
					headers: Admin.authHeaders()
				});

				if(!res.ok) return;

				employees = await res.json();
				const sel = document.getElementById('filterEmployee');
				sel.innerHTML = '<option value="">All Employees</option>' +
					employees.map(e => `<option value="${e._id}">${e.name}</option>`).join('');
			}catch(_){}
		}

		// Apply Filters
		function applyFilters(){
			const q = (searchTerm || '').toLowerCase();
			filteredRecords = callRecords.filter(r => {
				const matchesSearch = (r.lead?.name || '').toLowerCase().includes(q) ||
					(r.lead?.phone || '').toLowerCase().includes(q) ||
					(r.employee?.name || '').toLowerCase().includes(q) ||
					(r.callStatus || '').toLowerCase().includes(q);

				const matchesStatus = !filterStatus || r.callStatus === filterStatus;
				const matchesEmp = !filterEmployee || r.employee?._id === filterEmployee;
				const matchesRec = !filterHasRecording || (!!r.recordingFile || !!r.recordingUrl);

				const t = new Date(r.callStartTime || r.createdAt);
				const matchesFrom = !filterDateFrom || t >= new Date(filterDateFrom);
				const matchesTo = !filterDateTo || t <= new Date(new Date(filterDateTo).setHours(23, 59, 59, 999));

				return matchesSearch && matchesStatus && matchesEmp && matchesRec && matchesFrom && matchesTo;
			});

			currentPage = 1;
			renderCallRecords();
		}

		// Render Call Records
		function renderCallRecords(){
			const grid = document.getElementById('recordsGrid');
			const total = filteredRecords.length;

			if(!total){
				grid.innerHTML = `
					<tr>
						<td colspan="8">
							<div class="empty-state">
								<i class="fas fa-phone-slash"></i>
								<h3>No Call Records Found</h3>
								<p>No call records match your current filters</p>
							</div>
						</td>
					</tr>
				`;
				document.getElementById('paginationContainer').style.display = 'none';
				document.getElementById('count').textContent = '0';
				document.getElementById('total').textContent = '0';
				return;
			}

			const start = (currentPage - 1) * pageSize;
			const end = start + pageSize;
			const page = filteredRecords.slice(start, end);

			grid.innerHTML = page.map(r => `
				<tr>
					<td>
						<div class="lead-cell">
							<div class="lead-avatar">${(r.lead?.name || 'U').charAt(0).toUpperCase()}</div>
							<div class="lead-info">
								<div class="lead-name">${r.lead?.name || 'Unknown Lead'}</div>
								${r.lead?.email ? `<div class="lead-email">${r.lead.email}</div>` : ''}
							</div>
						</div>
					</td>
					<td>${r.lead?.phone || '-'}</td>
					<td>${r.employee?.name || 'Unknown'}</td>
					<td>
						<span class="badge badge-${r.callStatus || 'unknown'}">${r.callStatus || '-'}</span>
					</td>
					<td>${fmtDuration(r.callDuration)}</td>
					<td>${fmtDate(r.callStartTime)}</td>
					<td>
						${(r.recordingFile || r.recordingUrl) ? `
							<div class="btn-group">
								<button class="btn btn-outline btn-sm" onclick="playInModal('${r._id}')">
									<i class="fas fa-play"></i>
									Listen
								</button>
								<a class="btn btn-outline btn-sm" href="${r.recordingFile || r.recordingUrl}" download>
									<i class="fas fa-download"></i>
								</a>
							</div>
						` : '<span style="color: var(--fr-muted); font-size: 12px;">No recording</span>'}
					</td>
					<td>
						<div class="btn-group">
							<button class="btn btn-primary btn-sm" onclick="viewCallDetails('${r._id}')">
								<i class="fas fa-info-circle"></i>
								Details
							</button>
							<button class="btn btn-outline btn-sm" onclick="deleteCallRecord('${r._id}')">
								<i class="fas fa-trash"></i>
							</button>
						</div>
					</td>
				</tr>
			`).join('');

			updatePagination(total);
		}

		// Update Pagination
		function updatePagination(total){
			const container = document.getElementById('paginationContainer');
			const pages = Math.max(1, Math.ceil(total / pageSize));
			const start = (currentPage - 1) * pageSize + 1;
			const end = Math.min(currentPage * pageSize, total);

			document.getElementById('count').textContent = total ? `${start}-${end}` : '0';
			document.getElementById('total').textContent = total;
			document.getElementById('prev').disabled = currentPage <= 1;
			document.getElementById('next').disabled = currentPage >= pages;
			document.getElementById('pageNum').textContent = String(currentPage);
			container.style.display = 'flex';
		}

		// Play in Modal
		function playInModal(id){
			viewCallDetails(id);
		}

		// Change Playback Speed
		function changePlaybackSpeed(v){
			const audio = document.querySelector('#callDetailsContent audio');
			if(audio) audio.playbackRate = parseFloat(v);
		}

		// Close Call Details
		function closeCallDetails(){
			document.getElementById('callDetailsModal').style.display = 'none';
		}

		// View Call Details
		async function viewCallDetails(id){
			const rec = callRecords.find(r => r._id === id);
			if(!rec){
				alert('Not found');
				return;
			}

			const wrap = document.getElementById('callDetailsContent');
			wrap.innerHTML = `
				<div class="detail-grid">
					<div class="detail-card">
						<h4>Lead Information</h4>
						<div class="detail-item">
							<div class="detail-label">Name</div>
							<div class="detail-value">${rec.lead?.name || 'Unknown'}</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">Phone</div>
							<div class="detail-value">${rec.lead?.phone || '-'}</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">Email</div>
							<div class="detail-value">${rec.lead?.email || '-'}</div>
						</div>
					</div>

					<div class="detail-card">
						<h4>Call Information</h4>
						<div class="detail-item">
							<div class="detail-label">Employee</div>
							<div class="detail-value">${rec.employee?.name || 'Unknown'}</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">Status</div>
							<div class="detail-value">
								<span class="badge badge-${rec.callStatus || 'unknown'}">${rec.callStatus || '-'}</span>
							</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">Duration</div>
							<div class="detail-value">${fmtDuration(rec.callDuration)}</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">Started At</div>
							<div class="detail-value">${fmtDate(rec.callStartTime)}</div>
						</div>
					</div>
				</div>

				${(rec.recordingFile || rec.recordingUrl) ? `
					<div class="detail-card" style="margin-top: 24px;">
						<h4>Recording</h4>
						<audio controls preload="none" class="audio-player">
							<source src="${rec.recordingFile || rec.recordingUrl}" type="audio/mpeg">
						</audio>
						<div class="playback-controls">
							<label class="filter-label" for="pbSpeed" style="margin: 0;">Playback Speed:</label>
							<select id="pbSpeed" class="filter-select" onchange="changePlaybackSpeed(this.value)" style="width: 120px;">
								<option value="0.75">0.75x</option>
								<option value="1" selected>1x</option>
								<option value="1.25">1.25x</option>
								<option value="1.5">1.5x</option>
								<option value="2">2x</option>
							</select>
							<a class="btn btn-primary btn-sm" href="${rec.recordingFile || rec.recordingUrl}" download>
								<i class="fas fa-download"></i>
								Download
							</a>
						</div>
					</div>
				` : ''}

				${rec.notes ? `
					<div class="notes-box" style="margin-top: 24px;">
						<h4><i class="fas fa-sticky-note"></i> Notes</h4>
						<div class="notes-content">${rec.notes}</div>
					</div>
				` : ''}
			`;

			document.getElementById('callDetailsModal').style.display = 'flex';
		}

		// Delete Call Record
		async function deleteCallRecord(id){
			if(!confirm('Are you sure you want to delete this call record?')) return;

			try{
				const res = await fetch(`/api/admin/call-records/${id}`, {
					method: 'DELETE',
					headers: Admin.authHeaders()
				});

				if(!res.ok){
					const t = await res.text();
					alert('Failed to delete: ' + t);
					return;
				}

				callRecords = callRecords.filter(r => r._id !== id);
				updateStats();
				applyFilters();
			}catch(e){
				alert('Error deleting');
			}
		}

		// Toggle Auto Refresh
		function toggleAutoRefreshBtn(){
			const btn = document.getElementById('autoBtn');
			if(autoRefreshInterval){
				btn.innerHTML = '<i class="fas fa-pause"></i> Stop Auto-Refresh';
				btn.classList.remove('btn-outline');
				btn.classList.add('btn-success');
			}else{
				btn.innerHTML = '<i class="fas fa-sync"></i> Auto-Refresh (30s)';
				btn.classList.remove('btn-success');
				btn.classList.add('btn-outline');
			}
		}

		// DOM Ready
		document.addEventListener('DOMContentLoaded', () => {
			if(window.Admin && Admin.applyTheme){
				Admin.applyTheme();
			}

			Admin.navActivate('/admin/call-records.html');
			loadCallRecords();
			loadEmployees();

			// Event Listeners
			document.getElementById('btnRefresh').addEventListener('click', loadCallRecords);
			document.getElementById('search').addEventListener('input', e => {
				searchTerm = e.target.value;
				applyFilters();
			});
			document.getElementById('filterStatus').addEventListener('change', e => {
				filterStatus = e.target.value;
			});
			document.getElementById('filterEmployee').addEventListener('change', e => {
				filterEmployee = e.target.value;
			});
			document.getElementById('filterHasRecording').addEventListener('change', e => {
				filterHasRecording = e.target.checked;
			});
			document.getElementById('dateFrom').addEventListener('change', e => {
				filterDateFrom = e.target.value;
			});
			document.getElementById('dateTo').addEventListener('change', e => {
				filterDateTo = e.target.value;
			});
			document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
			document.getElementById('resetFiltersBtn').addEventListener('click', () => {
				searchTerm = '';
				filterStatus = '';
				filterEmployee = '';
				filterHasRecording = false;
				filterDateFrom = '';
				filterDateTo = '';
				document.getElementById('search').value = '';
				document.getElementById('filterStatus').value = '';
				document.getElementById('filterEmployee').value = '';
				document.getElementById('filterHasRecording').checked = false;
				document.getElementById('dateFrom').value = '';
				document.getElementById('dateTo').value = '';
				applyFilters();
			});
			document.getElementById('pageSize').addEventListener('change', e => {
				pageSize = parseInt(e.target.value) || 25;
				currentPage = 1;
				renderCallRecords();
			});
			document.getElementById('prev').addEventListener('click', () => {
				if(currentPage > 1){
					currentPage--;
					renderCallRecords();
				}
			});
			document.getElementById('next').addEventListener('click', () => {
				const pages = Math.max(1, Math.ceil(filteredRecords.length / pageSize));
				if(currentPage < pages){
					currentPage++;
					renderCallRecords();
				}
			});
			document.getElementById('autoBtn').addEventListener('click', () => {
				if(autoRefreshInterval){
					clearInterval(autoRefreshInterval);
					autoRefreshInterval = null;
				}else{
					autoRefreshInterval = setInterval(loadCallRecords, 30000);
				}
				toggleAutoRefreshBtn();
			});

			// Close modal on outside click
			window.addEventListener('click', (e) => {
				const m = document.getElementById('callDetailsModal');
				if(e.target === m) m.style.display = 'none';
			});
		});
	</script>
</body>
</html>
