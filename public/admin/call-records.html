<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Admin â€¢ Call Records</title>
	<link rel="stylesheet" href="../assets/frappe.css" />
	<style>
		/* Align with Admin Panel (Frappe UI) */
		.admin-shell{ display:flex; min-height:100vh; }
		.admin-sidebar{ width:260px; background:#0f172a; color:#cbd5e1; border-right:1px solid var(--fr-border); position:sticky; top:0; height:100vh; padding:0; }
		.brand{ padding:20px; border-bottom:1px solid rgba(255,255,255,.06); }
		.brand h1{ margin:0; font-size:18px; color:#fff; }
		.admin-sidebar nav{ padding:0; }
		.admin-sidebar nav a{ display:flex; align-items:center; gap:12px; padding:12px 16px; color:#cbd5e1; text-decoration:none; border-left:3px solid transparent; }
		.admin-sidebar nav a:hover,.admin-sidebar nav a.active{ background:rgba(94,100,255,.15); color:#fff; border-left-color:var(--fr-primary); }
		.admin-main{ flex:1; padding:24px; }
		.admin-topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
		.page-title{ font-size:22px; font-weight:600; margin:0; }
		.input{ width:100%; padding:10px 12px; border:1px solid var(--fr-border); border-radius:10px; background:var(--fr-surface); }
		.list-table{ width:100%; border-collapse:collapse; }
		.list-table th,.list-table td{ padding:12px 16px; border-bottom:1px solid var(--fr-border); text-align:left; }
		.list-table th{ font-size:12px; color:#64748b; font-weight:700; letter-spacing:.02em; text-transform:uppercase; }
		.badge{ display:inline-block; padding:2px 8px; border-radius:12px; background: var(--bg-secondary, var(--fr-bg)); font-size:12px; }
		.pagination{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:8px; }
		.modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); }
		.modal-content{ background:var(--fr-surface); border:1px solid var(--fr-border); border-radius:10px; margin:4% auto; padding:16px; width:92%; max-width:900px; max-height:85vh; overflow:auto; }
	</style>
</head>
<body>
	<div class="admin-shell">
		<aside class="admin-sidebar">
			<div class="brand"><h1>TeleCRM Admin</h1></div>
			<nav>
				<a href="/admin/overview.html">Overview</a>
				<a href="/admin/users.html">Users</a>
				<a href="/admin/leads.html">Leads</a>
				<a href="/admin/call-records.html" class="active">Call Records</a>
				<a href="/admin/settings.html">Settings</a>
				<a href="/admin/mailbox.html">Mailbox</a>
			</nav>
		</aside>
		<main class="admin-main">
			<div class="admin-topbar">
				<h2 class="page-title">Call Records</h2>
				<div class="toolbar" style="display:flex;gap:8px">
					<button class="btn" id="themeToggle">Theme</button>
					<button class="btn" id="btnRefresh">Refresh</button>
					<a class="btn btn-outline" href="/login.html" onclick="logout(event)">Logout</a>
				</div>
			</div>

			<div class="grid cols-3" style="gap:12px">
				<div class="card" style="grid-column: span 1">
					<h4>Filters</h4>
					<label>Search</label>
					<input class="input" id="search" placeholder="Lead, phone, employee, status" />
					<div class="grid cols-2" style="gap:8px; margin-top:8px">
						<div>
							<label>Status</label>
							<select class="input" id="filterStatus">
								<option value="">All</option>
								<option value="completed">Completed</option>
								<option value="missed">Missed</option>
								<option value="declined">Declined</option>
								<option value="not_lifted">Not Lifted</option>
								<option value="busy">Busy</option>
								<option value="unreachable">Unreachable</option>
								<option value="voicemail">Voicemail</option>
							</select>
						</div>
						<div>
							<label>Employee</label>
							<select class="input" id="filterEmployee"><option value="">All</option></select>
						</div>
					</div>
					<div class="grid cols-2" style="gap:8px; margin-top:8px">
						<div>
							<label>From</label>
							<input class="input" type="date" id="dateFrom" />
						</div>
						<div>
							<label>To</label>
							<input class="input" type="date" id="dateTo" />
						</div>
					</div>
					<div style="margin-top:8px">
						<label><input type="checkbox" id="filterHasRecording" /> Has recording</label>
					</div>
					<div style="display:flex; gap:8px; margin-top:8px">
						<button class="btn" id="applyFiltersBtn">Apply</button>
						<button class="btn btn-outline" id="resetFiltersBtn">Reset</button>
					</div>
					<div style="margin-top:8px">
						<label>Page size</label>
						<select id="pageSize" class="input">
							<option value="10">10</option>
							<option value="25" selected>25</option>
							<option value="50">50</option>
							<option value="100">100</option>
						</select>
					</div>
					<div style="display:flex; gap:8px; margin-top:8px">
						<button class="btn btn-outline" id="autoBtn">Auto-refresh</button>
					</div>
				</div>
				<div class="card" style="grid-column: span 2">
					<div class="toolbar" style="justify-content:space-between; align-items:center">
						<div class="muted">Showing <span id="count">0</span> of <span id="total">0</span></div>
						<div class="grid cols-4" style="gap:8px">
							<div class="card" style="padding:8px"><div class="muted">Total</div><div id="totalCalls">0</div></div>
							<div class="card" style="padding:8px"><div class="muted">With Recordings</div><div id="recordedCalls">0</div></div>
							<div class="card" style="padding:8px"><div class="muted">Avg Duration</div><div id="avgDuration">0m</div></div>
							<div class="card" style="padding:8px"><div class="muted">Today</div><div id="todayCalls">0</div></div>
						</div>
					</div>
					<div style="overflow:auto; margin-top:8px">
						<table class="list-table">
							<thead>
								<tr>
									<th>Lead</th>
									<th>Phone</th>
									<th>Employee</th>
									<th>Status</th>
									<th>Duration</th>
									<th>Date</th>
									<th>Recording</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody id="recordsGrid"></tbody>
						</table>
					</div>
					<div class="pagination" id="paginationContainer" style="display:none">
						<div style="display:flex;gap:8px;align-items:center">
							<button class="btn btn-outline" id="prev">Prev</button>
							<button class="btn btn-outline" id="next">Next</button>
						</div>
						<div class="muted">Page <span id="pageNum">1</span></div>
					</div>
				</div>
			</div>
		</main>
	</div>

	<div id="callDetailsModal" class="modal">
		<div class="modal-content">
			<div class="toolbar" style="justify-content:space-between;align-items:center">
				<h3>Call Details</h3>
				<button class="btn btn-outline" onclick="closeCallDetails()">Close</button>
			</div>
			<div id="callDetailsContent"></div>
		</div>
	</div>

	<script src="../assets/admin.js"></script>
	<script>
		Admin && Admin.navActivate && Admin.navActivate('/admin/call-records.html');
		(function(){
			const btn = document.getElementById('themeToggle');
			if(btn){ btn.addEventListener('click', ()=>{ const cur=localStorage.getItem('uiTheme')||'light'; const next=cur==='light'?'semi':(cur==='semi'?'dark':'light'); Admin.setTheme(next); }); }
		})();
		function logout(e){ e && e.preventDefault(); try{ localStorage.removeItem('token'); localStorage.removeItem('role'); }catch(_){ } location.href='/login.html'; }

		let callRecords=[]; let filteredRecords=[]; let currentPage=1; let pageSize=25; let searchTerm='';
		let autoRefreshInterval=null; let filterStatus=''; let filterEmployee=''; let filterHasRecording=false; let filterDateFrom=''; let filterDateTo=''; let employees=[];

		function fmtDate(d){ try{ return new Date(d).toLocaleString(); }catch(e){ return '-'; } }
		function fmtDuration(s){ if(!s) return '0s'; const m=Math.floor(s/60), sec=s%60; return m?`${m}m ${sec}s`:`${sec}s`; }

		function updateStats(){
			const total = callRecords.length;
			const rec = callRecords.filter(r=> r.recordingFile||r.recordingUrl).length;
			const avg = total>0 ? Math.round(callRecords.reduce((sum,r)=>sum+(r.callDuration||0),0)/total/60) : 0;
			const today = new Date().toDateString();
			const todayCount = callRecords.filter(r=> new Date(r.callStartTime).toDateString()===today).length;
			document.getElementById('totalCalls').textContent = total;
			document.getElementById('recordedCalls').textContent = rec;
			document.getElementById('avgDuration').textContent = `${avg}m`;
			document.getElementById('todayCalls').textContent = todayCount;
		}

		async function loadCallRecords(){
			try{
				const token = Admin.getToken(); if(!token){ alert('Please login first'); return; }
				const res = await fetch('/api/admin/call-records',{ headers: Admin.authHeaders() });
				if(!res.ok){ const t=await res.text(); alert('Failed to load: '+t); return; }
				callRecords = await res.json();
				updateStats();
				applyFilters();
			}catch(e){ console.error(e); alert('Error loading call records'); }
		}

		async function loadEmployees(){
			try{ const res = await fetch('/api/admin/employees',{ headers: Admin.authHeaders() }); if(!res.ok) return; employees = await res.json(); const sel=document.getElementById('filterEmployee'); sel.innerHTML = '<option value=\"\">All</option>' + employees.map(e=>`<option value=\"${e._id}\">${e.name}</option>`).join(''); }catch(_){ }
		}

		function applyFilters(){
			const q=(searchTerm||'').toLowerCase();
			filteredRecords = callRecords.filter(r=>{
				const matchesSearch = (r.lead?.name||'').toLowerCase().includes(q) || (r.lead?.phone||'').toLowerCase().includes(q) || (r.employee?.name||'').toLowerCase().includes(q) || (r.callStatus||'').toLowerCase().includes(q);
				const matchesStatus = !filterStatus || r.callStatus===filterStatus;
				const matchesEmp = !filterEmployee || r.employee?._id===filterEmployee;
				const matchesRec = !filterHasRecording || (!!r.recordingFile || !!r.recordingUrl);
				const t = new Date(r.callStartTime || r.createdAt);
				const matchesFrom = !filterDateFrom || t >= new Date(filterDateFrom);
				const matchesTo = !filterDateTo || t <= new Date(new Date(filterDateTo).setHours(23,59,59,999));
				return matchesSearch && matchesStatus && matchesEmp && matchesRec && matchesFrom && matchesTo;
			});
			currentPage = 1; renderCallRecords();
		}

		function renderCallRecords(){
			const grid = document.getElementById('recordsGrid'); const total = filteredRecords.length;
			if(!total){ grid.innerHTML = '<tr><td colspan=\"8\" class=\"muted\" style=\"text-align:center;padding:24px\">No call records</td></tr>'; document.getElementById('paginationContainer').style.display='none'; document.getElementById('count').textContent='0'; document.getElementById('total').textContent='0'; return; }
			const start=(currentPage-1)*pageSize; const end=start+pageSize; const page = filteredRecords.slice(start,end);
			grid.innerHTML = page.map(r=>`
				<tr>
					<td>
						<div style="display:flex;gap:8px;align-items:center">
							<div class="badge">${(r.lead?.name||'U').charAt(0).toUpperCase()}</div>
							<div>
								<div style="font-weight:600">${r.lead?.name||'Unknown Lead'}</div>
								<div class="muted" style="font-size:12px">${r.lead?.email||''}</div>
							</div>
						</div>
					</td>
					<td>${r.lead?.phone||'-'}</td>
					<td>${r.employee?.name||'Unknown'}</td>
					<td><span class="badge">${r.callStatus||'-'}</span></td>
					<td>${fmtDuration(r.callDuration)}</td>
					<td>${fmtDate(r.callStartTime)}</td>
					<td>
						${(r.recordingFile||r.recordingUrl)?`<div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn btn-outline" onclick="playInModal('${r._id}')">Listen</button><a class="btn" href="${r.recordingFile||r.recordingUrl}" download>Download</a></div>`:'<span class="muted" style="font-size:12px">No recording</span>'}
					</td>
					<td>
						<div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn" onclick="viewCallDetails('${r._id}')">Details</button><button class="btn btn-outline" onclick="deleteCallRecord('${r._id}')">Delete</button></div>
					</td>
				</tr>
			`).join('');
			updatePagination(total);
		}

		function updatePagination(total){
			const container=document.getElementById('paginationContainer'); const pages=Math.max(1, Math.ceil(total/pageSize)); const start=(currentPage-1)*pageSize+1; const end=Math.min(currentPage*pageSize,total);
			document.getElementById('count').textContent = total?`${start}-${end}`:'0';
			document.getElementById('total').textContent = total;
			document.getElementById('prev').disabled = currentPage<=1;
			document.getElementById('next').disabled = currentPage>=pages;
			document.getElementById('pageNum').textContent = String(currentPage);
			container.style.display='flex';
		}

		function playInModal(id){ viewCallDetails(id); }

		function changePlaybackSpeed(v){ const audio=document.querySelector('#callDetailsContent audio'); if(audio) audio.playbackRate=parseFloat(v); }

		function closeCallDetails(){ document.getElementById('callDetailsModal').style.display='none'; }

		async function viewCallDetails(id){
			const rec = callRecords.find(r=> r._id===id); if(!rec){ alert('Not found'); return; }
			const wrap=document.getElementById('callDetailsContent');
			wrap.innerHTML = `
				<div class="grid cols-2" style="gap:12px">
					<div class="card"><h4>Lead</h4><div class="list"><div class="list-item"><div class="muted">Name</div><div>${rec.lead?.name||'Unknown'}</div></div><div class="list-item"><div class="muted">Phone</div><div>${rec.lead?.phone||'-'}</div></div></div></div>
					<div class="card"><h4>Call</h4><div class="list"><div class="list-item"><div class="muted">Employee</div><div>${rec.employee?.name||'Unknown'}</div></div><div class="list-item"><div class="muted">Status</div><div>${rec.callStatus||'-'}</div></div><div class="list-item"><div class="muted">Duration</div><div>${fmtDuration(rec.callDuration)}</div></div><div class="list-item"><div class="muted">Start</div><div>${fmtDate(rec.callStartTime)}</div></div></div></div>
				</div>
				${(rec.recordingFile||rec.recordingUrl)?`<div class="card"><h4>Recording</h4><audio controls preload="none" class="input" style="height:40px"><source src="${rec.recordingFile||rec.recordingUrl}" type="audio/mpeg"></audio><div class="toolbar" style="gap:8px;margin-top:6px"><label class="muted" for="pbSpeed">Speed</label><select id="pbSpeed" class="input" onchange="changePlaybackSpeed(this.value)"><option value="0.75">0.75x</option><option value="1" selected>1x</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option><option value="2">2x</option></select><a class="btn" href="${rec.recordingFile||rec.recordingUrl}" download>Download</a></div></div>`:''}
				${rec.notes?`<div class="card"><h4>Notes</h4><div class="prose">${rec.notes}</div></div>`:''}
			`;
			document.getElementById('callDetailsModal').style.display='block';
		}

		async function deleteCallRecord(id){ if(!confirm('Delete this call record?')) return; try{ const res=await fetch(`/api/admin/call-records/${id}`,{ method:'DELETE', headers: Admin.authHeaders() }); if(!res.ok){ const t=await res.text(); alert('Failed to delete: '+t); return; } callRecords = callRecords.filter(r=> r._id!==id); updateStats(); applyFilters(); }catch(e){ alert('Error deleting'); } }

		function toggleAutoRefreshBtn(){ const btn=document.getElementById('autoBtn'); if(autoRefreshInterval){ btn.textContent='Stop refresh'; btn.classList.remove('btn-outline'); }else{ btn.textContent='Auto-refresh'; btn.classList.add('btn-outline'); } }

		document.addEventListener('DOMContentLoaded', ()=>{
			if(window.Admin && Admin.applyTheme){ Admin.applyTheme(); }
			Admin.navActivate('/admin/call-records.html');
			loadCallRecords();
			loadEmployees();
			document.getElementById('btnRefresh').addEventListener('click', loadCallRecords);
			document.getElementById('search').addEventListener('input', e=>{ searchTerm=e.target.value; applyFilters(); });
			document.getElementById('filterStatus').addEventListener('change', e=>{ filterStatus=e.target.value; });
			document.getElementById('filterEmployee').addEventListener('change', e=>{ filterEmployee=e.target.value; });
			document.getElementById('filterHasRecording').addEventListener('change', e=>{ filterHasRecording=e.target.checked; });
			document.getElementById('dateFrom').addEventListener('change', e=>{ filterDateFrom=e.target.value; });
			document.getElementById('dateTo').addEventListener('change', e=>{ filterDateTo=e.target.value; });
			document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
			document.getElementById('resetFiltersBtn').addEventListener('click', ()=>{
				searchTerm=''; filterStatus=''; filterEmployee=''; filterHasRecording=false; filterDateFrom=''; filterDateTo='';
				document.getElementById('search').value='';
				document.getElementById('filterStatus').value='';
				document.getElementById('filterEmployee').value='';
				document.getElementById('filterHasRecording').checked=false;
				document.getElementById('dateFrom').value='';
				document.getElementById('dateTo').value='';
				applyFilters();
			});
			document.getElementById('pageSize').addEventListener('change', e=>{ pageSize=parseInt(e.target.value)||25; currentPage=1; renderCallRecords(); });
			document.getElementById('prev').addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; renderCallRecords(); } });
			document.getElementById('next').addEventListener('click', ()=>{ const pages=Math.max(1, Math.ceil(filteredRecords.length/pageSize)); if(currentPage<pages){ currentPage++; renderCallRecords(); } });
			document.getElementById('autoBtn').addEventListener('click', ()=>{ if(autoRefreshInterval){ clearInterval(autoRefreshInterval); autoRefreshInterval=null; }else{ autoRefreshInterval=setInterval(loadCallRecords,30000); } toggleAutoRefreshBtn(); });
			window.addEventListener('click', (e)=>{ const m=document.getElementById('callDetailsModal'); if(e.target===m) m.style.display='none'; });
		});
	</script>
</body>
</html>