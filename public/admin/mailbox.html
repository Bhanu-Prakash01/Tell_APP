<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Admin â€¢ Mailbox</title>
	<link rel="stylesheet" href="../assets/frappe.css" />
	<style>
		.mail-list .list-item{ transition: background .15s ease, box-shadow .15s ease; }
		.mail-list .list-item.active{ background: var(--bg-secondary); box-shadow: inset 0 0 0 1px var(--border-color); }
		.badge{ display:inline-block; padding:2px 8px; border-radius:12px; background: var(--bg-secondary); font-size:12px; }
		#folderHeader{ display:flex; align-items:center; justify-content:space-between; padding:6px 8px; margin:6px; }
		/* density */
		:root{ --mail-row-pad: 10px 12px; --mail-row-gap: 8px; }
		.density-compact :root, .density-compact{ --mail-row-pad: 6px 10px; --mail-row-gap: 6px; }
		.density-comfortable :root, .density-comfortable{ --mail-row-pad: 12px 14px; --mail-row-gap: 10px; }
	</style>
</head>
<body>
	<div class="admin-shell">
		<aside class="admin-sidebar">
			<div class="brand"><h1>TeleCRM Admin</h1></div>
			<nav>
				<a href="/admin/overview.html">Overview</a>
				<a href="/admin/users.html">Users</a>
				<a href="/admin/leads.html">Leads</a>
				<a href="/admin/call-records.html">Call Records</a>
				<a href="/admin/settings.html">Settings</a>
				<a href="/admin/mailbox.html" class="active">Mailbox</a>
			</nav>
		</aside>
		<main class="admin-main">
			<div class="admin-topbar">
				<h2 class="page-title">Mailbox</h2>
				<div class="toolbar">
					<button class="btn" id="btnRefresh">Refresh</button>
					<button class="btn" id="btnCompose">Compose</button>
					<a class="btn btn-outline" href="/login.html" onclick="logout(event)">Logout</a>
				</div>
			</div>

			<div class="card" style="margin-bottom:12px">
				<div class="grid cols-3">
					<div>
						<label>Email</label>
					<input class="input" id="mbEmail" type="email" placeholder="you@example.com" />
					</div>
					<div>
						<label>Password</label>
					<input class="input" id="mbPass" type="password" placeholder="password" />
					</div>
					<div style="display:flex;align-items:flex-end;gap:8px">
						<button class="btn" id="btnValidate">Connect</button>
						<span id="mbStatus" class="muted"></span>
					</div>
				</div>
			</div>

			<div class="grid cols-3" style="gap:12px">
				<div class="card" style="grid-column: span 1">
					<div class="toolbar" style="gap:8px; align-items:center; justify-content:space-between">
						<div id="folderQuick" class="segmented">
							<button class="btn btn-outline" data-folder="INBOX">Inbox</button>
							<button class="btn btn-outline" data-folder="Sent">Sent</button>
							<button class="btn btn-outline" data-folder="Drafts">Drafts</button>
							<button class="btn btn-outline" data-folder="Trash">Trash</button>
						</div>
					</div>
					<div class="muted" style="margin:6px 0">Other folders</div>
					<select class="input" id="folderSelect" style="width:100%"></select>
					<div id="folderHeader"><div id="folderTitle">Inbox</div><div class="badge" id="folderCount">0</div></div>
					<div class="list mail-list" id="inboxList" style="max-height:64vh;overflow:auto"></div>
				</div>
				<div class="card" style="grid-column: span 2">
					<div class="toolbar" style="gap:8px; margin-bottom:8px; flex-wrap:wrap">
						<input class="input" id="searchQ" placeholder="Search sender/subject" />
						<input class="input" id="searchFrom" placeholder="From" />
						<input class="input" id="searchSince" type="date" />
						<input class="input" id="searchBefore" type="date" />
						<button class="btn" id="btnSearch">Search</button>
					<div style="margin-left:auto;display:flex;gap:6px;align-items:center">
						<label class="muted" for="densitySel">Density</label>
						<select class="input" id="densitySel">
							<option value="default">Default</option>
							<option value="compact">Compact</option>
							<option value="comfortable">Comfortable</option>
						</select>
					</div>
					</div>
					<div id="messageView" class="prose" style="min-height:300px; max-height:64vh; overflow:auto">Select an email to view</div>
					<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
						<button class="btn" id="btnReply" disabled>Reply</button>
						<button class="btn" id="btnForward" disabled>Forward</button>
						<button class="btn btn-outline" id="btnDelete" disabled>Delete</button>
					</div>
				</div>
			</div>
		</main>
	</div>

		<div class="modal" id="composeModal" style="display:none">
		<div class="modal-content" style="max-width:720px">
				<h3>Compose Email</h3>
				<div class="grid cols-2">
				<div>
					<label>To</label>
					<input class="input" id="cTo" placeholder="recipient@example.com" />
				</div>
				<div>
					<label>Subject</label>
					<input class="input" id="cSubject" placeholder="" />
				</div>
			</div>
				<div class="segmented" style="margin:6px 0">
					<button class="btn btn-outline" id="cModePlain" aria-pressed="true">Plain</button>
					<button class="btn btn-outline" id="cModeHtml">Rich Text</button>
				</div>
				<label>Message</label>
				<textarea class="input" id="cBody" rows="10"></textarea>
				<div id="cHtmlWrap" style="display:none;border:1px solid var(--border-color);border-radius:6px;overflow:hidden">
					<iframe id="cHtmlEditor" style="width:100%;min-height:260px;border:0"></iframe>
				</div>
			<div style="margin-top:8px">
				<label>Attachments</label>
					<input class="input" id="cFiles" type="file" multiple />
			</div>
			<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
				<button class="btn btn-outline" id="cCancel">Cancel</button>
				<button class="btn" id="cSend">Send</button>
			</div>
		</div>
	</div>

	<script src="../assets/admin.js"></script>
	<script>
		Admin.navActivate('/admin/mailbox.html');
		function logout(e){ e && e.preventDefault(); localStorage.removeItem('token'); localStorage.removeItem('role'); location.href='/login.html'; }

		const el = (id)=> document.getElementById(id);
		const state = { selectedUid: null, folder: 'INBOX', selectedMsgMeta: null };
		const MAIL_CONST = { incomingServer: 'mail.outreachq.com', incomingPort: 993, outgoingServer: 'mail.outreachq.com', outgoingPort: 465 };

		function readCreds(){
			return {
				username: el('mbEmail').value.trim(),
				password: el('mbPass').value,
				incomingServer: MAIL_CONST.incomingServer,
				incomingPort: MAIL_CONST.incomingPort,
				outgoingServer: MAIL_CONST.outgoingServer,
				outgoingPort: MAIL_CONST.outgoingPort
			};
		}

		function saveSessionCreds(){
			try{ sessionStorage.setItem('mailUser', el('mbEmail').value.trim()); }catch(_){ }
		}
		function restoreSessionCreds(){
			const vault = (window.CredVault && window.CredVault.load && window.CredVault.load()) || null;
			if(vault){ el('mbEmail').value = vault.email || ''; el('mbPass').value = vault.password || ''; validateCreds(); return; }
			const u = sessionStorage.getItem('mailUser');
			if(u){ el('mbEmail').value = u; }
		}

		async function validateCreds(){
			el('mbStatus').textContent = 'Validating...';
			const res = await fetch('/api/admin/mail/validate',{
				method:'POST', headers: { 'Content-Type':'application/json', ...Admin.authHeaders() },
				body: JSON.stringify(readCreds())
			});
			const data = await res.json();
			if(res.ok){ el('mbStatus').textContent = 'Connected'; highlightFolder(state.folder); loadInbox(); saveSessionCreds(); try{ window.CredVault && window.CredVault.save(el('mbEmail').value.trim(), el('mbPass').value); }catch(_){ } }
			else{ el('mbStatus').textContent = data?.error || 'Validation failed'; }
		}

		async function loadInbox(){
			const list = el('inboxList'); list.innerHTML = 'Loading...';
			const res = await fetch(`/api/admin/mail/inbox?limit=50&mailbox=${encodeURIComponent(state.folder)}`,{
				method: 'POST', headers: { 'Content-Type':'application/json', ...Admin.authHeaders() },
				body: JSON.stringify(readCreds())
			});
			if(!res.ok){ list.innerHTML = 'Failed to load inbox'; return; }
			const { items = [] } = await res.json();
			list.innerHTML = '';
			el('folderTitle').textContent = state.folder;
			el('folderCount').textContent = String(items.length);
			if(items.length===0){ list.innerHTML = '<div class="muted" style="padding:12px">No emails</div>'; return; }
			items.forEach(it=>{
				const row = document.createElement('div');
				row.className = 'list-item';
				row.style.display='grid';
				row.style.gridTemplateColumns='1fr auto';
				row.style.gap='var(--mail-row-gap)';
				row.style.padding='var(--mail-row-pad)';
				row.style.border='1px solid var(--border-color)';
				row.style.borderRadius='8px';
				row.style.margin='6px';
				row.setAttribute('data-uid', String(it.uid));
				const left = document.createElement('div');
				left.innerHTML = `<div class=\"title\" style=\"font-weight:600\">${it.subject||'(no subject)'}</div><div class=\"muted\" style=\"margin-top:2px\">${it.from||''}</div>`;
				const right = document.createElement('div');
				right.className='muted';
				right.style.fontSize='12px';
				right.textContent = Admin.fmtDate(it.date);
				row.appendChild(left);
				row.appendChild(right);
				row.addEventListener('click', ()=> openMessage(it.uid));
				row.addEventListener('mouseenter', ()=> row.style.background='var(--bg-secondary)');
				row.addEventListener('mouseleave', ()=> row.style.background='transparent');
				list.appendChild(row);
			});
		}

		async function openMessage(uid){
			state.selectedUid = uid;
			try{
				Admin.qsa('#inboxList .list-item').forEach(r=>{
					if(r.getAttribute('data-uid')===String(uid)) r.classList.add('active'); else r.classList.remove('active');
				});
			}catch(_){ }
			el('btnReply').disabled = false;
			el('btnForward').disabled = false;
			el('btnDelete').disabled = false;
			const view = el('messageView');
			view.textContent = 'Loading message...';
			const res = await fetch(`/api/admin/mail/message/${uid}?mailbox=${encodeURIComponent(state.folder)}`,{
				method:'POST', headers: { 'Content-Type':'application/json', ...Admin.authHeaders() },
				body: JSON.stringify(readCreds())
			});
			if(!res.ok){ view.textContent = 'Failed to load message'; return; }
			const msg = await res.json();
			state.selectedMsgMeta = msg;
			// Render attachments list
			const att = (msg.attachments||[]).map(a=>`<li><a href="#" data-part="${a.part}" data-fn="${a.filename}" class="dlAtt">${a.filename} (${a.mimeType||''})</a></li>`).join('');
			// Prefer html from backend, then text, then raw
			const html = msg.html || '';
			const text = msg.text || '';
			const raw = msg.raw || '';
			const looksHtml = !!html || /<html|<body|<div|<p|<table/i.test(raw);
			const headerHtml = `<div class="muted">From: ${msg.from||''} â€¢ ${Admin.fmtDate(msg.date)}</div><h3>${msg.subject||''}</h3>${att?`<div><strong>Attachments</strong><ul>${att}</ul></div>`:''}`;
			if(looksHtml){
				view.innerHTML = `${headerHtml}<div style="border:1px solid var(--border-color);border-radius:6px;overflow:hidden;min-height:240px"><iframe id="msgFrame" sandbox="allow-popups allow-popups-to-escape-sandbox" style="width:100%;min-height:480px;max-height:58vh;border:0" referrerpolicy="no-referrer" loading="lazy"></iframe></div>`;
				const iframe = document.getElementById('msgFrame');
				try{ iframe.srcdoc = html || raw; }catch(_){
					// fallback to escaped pre
					view.innerHTML = `${headerHtml}<pre style="white-space:pre-wrap">${(text||raw).replace(/[<>&]/g,(c)=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[c]))}</pre>`;
				}
			} else {
				view.innerHTML = `${headerHtml}<pre style=\"white-space:pre-wrap\">${(text||raw).replace(/[<>&]/g,(c)=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[c]))}</pre>`;
			}
			Array.from(view.querySelectorAll('.dlAtt')).forEach(a=> a.addEventListener('click', downloadAttachment));
		}

		function openCompose(prefill){
			el('composeModal').style.display='block';
			el('cTo').value = prefill?.to || '';
			el('cSubject').value = prefill?.subject || '';
			el('cBody').value = prefill?.body || '';
			// initialize simple rich text editor doc
			try{
				const iframe = el('cHtmlEditor');
				const doc = iframe.contentDocument || iframe.contentWindow?.document;
				doc.open();
				doc.write('<!doctype html><html><head><meta charset="utf-8"></head><body style="font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:12px;">'+(prefill?.body||'')+'</body></html>');
				doc.close();
				doc.body.contentEditable = 'true';
			}catch(_){ }
		}
		function closeCompose(){ el('composeModal').style.display='none'; }

		async function sendMail(){
			const files = Array.from(el('cFiles').files||[]);
			const attachments = await Promise.all(files.map(f=> new Promise((resolve)=>{ const r=new FileReader(); r.onload=()=> resolve({ filename:f.name, content: btoa(r.result.split(',')[1]||''), contentType: f.type||'application/octet-stream' }); r.readAsDataURL(f); } ) ));
			let html = '';
			try{ const doc = el('cHtmlEditor').contentDocument; html = doc && doc.body ? doc.body.innerHTML : ''; }catch(_){ }
			const body = { ...readCreds(), to: el('cTo').value.trim(), subject: el('cSubject').value, text: el('cBody').value, html, attachments };
			const res = await fetch('/api/admin/mail/send',{
				method:'POST', headers: { 'Content-Type':'application/json', ...Admin.authHeaders() },
				body: JSON.stringify(body)
			});
			if(res.ok){ closeCompose(); loadInbox(); }
		}

		async function deleteSelected(){
			if(!state.selectedUid) return;
			if(!confirm('Delete this email?')) return;
			await fetch(`/api/admin/mail/trash/${state.selectedUid}?mailbox=${encodeURIComponent(state.folder)}`,{
				method:'POST', headers: { 'Content-Type':'application/json', ...Admin.authHeaders() },
				body: JSON.stringify(readCreds())
			});
			state.selectedUid = null; el('messageView').textContent = 'Select an email to view'; el('btnReply').disabled = true; el('btnDelete').disabled = true; loadInbox();
		}

		async function downloadAttachment(e){
			e && e.preventDefault();
			const anchor = e.currentTarget; const part = anchor.getAttribute('data-part'); const fn = anchor.getAttribute('data-fn')||'attachment';
			const res = await fetch(`/api/admin/mail/attachment/${state.selectedUid}?mailbox=${encodeURIComponent(state.folder)}&part=${encodeURIComponent(part)}`,{
				method:'POST', headers: { 'Content-Type':'application/json', ...Admin.authHeaders() }, body: JSON.stringify(readCreds())
			});
			if(!res.ok) return;
			const data = await res.json();
			const url = `data:${data.mimeType};base64,${data.b64}`;
			const a = document.createElement('a'); a.href = url; a.download = data.filename || fn; document.body.appendChild(a); a.click(); a.remove();
		}

		async function loadFolders(){
			const res = await fetch('/api/admin/mail/folders',{ method:'POST', headers: { 'Content-Type':'application/json', ...Admin.authHeaders() }, body: JSON.stringify(readCreds()) });
			if(!res.ok) return; const j = await res.json();
			const sel = el('folderSelect');
			sel.innerHTML = j.folders.map(f=>`<option value="${f.path}">${f.name}</option>`).join('');
			sel.value = 'INBOX';
			sel.addEventListener('change', ()=>{ state.folder = sel.value; highlightFolder(null); loadInbox(); });
		}

		async function runSearch(){
			const params = new URLSearchParams();
			const q = el('searchQ').value.trim(); if(q) params.append('q', q);
			const from = el('searchFrom').value.trim(); if(from) params.append('from', from);
			const since = el('searchSince').value; if(since) params.append('since', since);
			const before = el('searchBefore').value; if(before) params.append('before', before);
			params.append('mailbox', state.folder);
			const list = el('inboxList'); list.innerHTML = 'Searching...';
			const res = await fetch(`/api/admin/mail/search?${params.toString()}`,{ method:'POST', headers: { 'Content-Type':'application/json', ...Admin.authHeaders() }, body: JSON.stringify(readCreds()) });
			if(!res.ok){ list.innerHTML = 'Search failed'; return; }
			const { items=[] } = await res.json();
			list.innerHTML = '';
			el('folderTitle').textContent = `${state.folder} â€¢ Search`;
			el('folderCount').textContent = String(items.length);
			if(items.length===0){ list.innerHTML = '<div class="muted" style="padding:12px">No results</div>'; return; }
			items.forEach(it=>{
				const row = document.createElement('div');
				row.className = 'list-item';
				row.style.display='grid';
				row.style.gridTemplateColumns='1fr auto';
				row.style.gap='var(--mail-row-gap)';
				row.style.padding='var(--mail-row-pad)';
				row.style.border='1px solid var(--border-color)';
				row.style.borderRadius='8px';
				row.style.margin='6px';
				row.setAttribute('data-uid', String(it.uid));
				const left = document.createElement('div');
				left.innerHTML = `<div class=\"title\" style=\"font-weight:600\">${it.subject||'(no subject)'}<\/div><div class=\"muted\" style=\"margin-top:2px\">${it.from||''}<\/div>`;
				const right = document.createElement('div');
				right.className='muted';
				right.style.fontSize='12px';
				right.textContent = Admin.fmtDate(it.date);
				row.appendChild(left);
				row.appendChild(right);
				row.addEventListener('click', ()=> openMessage(it.uid));
				row.addEventListener('mouseenter', ()=> row.style.background='var(--bg-secondary)');
				row.addEventListener('mouseleave', ()=> row.style.background='transparent');
				list.appendChild(row);
			});
		}

		function highlightFolder(name){
			Admin.qsa('#folderQuick .btn').forEach(b=>{
				if(!name){ b.classList.remove('active'); return; }
				const f = b.getAttribute('data-folder');
				if(f===name) b.classList.add('active'); else b.classList.remove('active');
			});
		}

		// wire UI
		el('btnValidate').addEventListener('click', validateCreds);
		el('btnRefresh').addEventListener('click', loadInbox);
		el('btnCompose').addEventListener('click', ()=> openCompose());
		el('cCancel').addEventListener('click', closeCompose);
		el('cSend').addEventListener('click', sendMail);
		el('btnReply').addEventListener('click', ()=>{
			if(!state.selectedUid) return;
			const subj = document.querySelector('#messageView h3')?.textContent || '';
			openCompose({ subject: subj.startsWith('Re:')?subj:`Re: ${subj}`, body: `\n\n---- reply above ----\n` });
		});
		el('btnForward').addEventListener('click', ()=>{
			if(!state.selectedUid) return;
			const subj = document.querySelector('#messageView h3')?.textContent || '';
			const raw = state.selectedMsgMeta?.raw || '';
			openCompose({ subject: subj.startsWith('Fwd:')?subj:`Fwd: ${subj}`, body: `\n\n---- Forwarded message ----\n${raw}` });
		});
		el('btnDelete').addEventListener('click', deleteSelected);
		el('btnSearch').addEventListener('click', runSearch);
		// density toggle
		(function(){
			const key='mailDensity';
			function applyDensity(val){
				document.documentElement.classList.remove('density-compact','density-comfortable');
				if(val==='compact') document.documentElement.classList.add('density-compact');
				if(val==='comfortable') document.documentElement.classList.add('density-comfortable');
				el('densitySel').value = val||'default';
			}
			try{ const saved = localStorage.getItem(key)||'default'; applyDensity(saved); }catch(_){ }
			el('densitySel').addEventListener('change', ()=>{ const v=el('densitySel').value; try{ localStorage.setItem(key, v); }catch(_){ } applyDensity(v); });
		})();
		// compose mode toggle
		el('cModePlain').addEventListener('click', ()=>{ el('cModePlain').setAttribute('aria-pressed','true'); el('cModeHtml').setAttribute('aria-pressed','false'); el('cHtmlWrap').style.display='none'; el('cBody').style.display='block'; });
		el('cModeHtml').addEventListener('click', ()=>{ el('cModePlain').setAttribute('aria-pressed','false'); el('cModeHtml').setAttribute('aria-pressed','true'); el('cHtmlWrap').style.display='block'; el('cBody').style.display='none'; });
		Admin.qsa('#folderQuick .btn').forEach(b=> b.addEventListener('click', ()=>{ state.folder = b.getAttribute('data-folder'); highlightFolder(state.folder); loadInbox(); }));
		loadFolders();

		restoreSessionCreds();
	</script>
</body>
</html>


