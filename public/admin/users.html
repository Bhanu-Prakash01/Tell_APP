<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Admin â€¢ Users</title>
	<link rel="stylesheet" href="../assets/frappe.css" />
	<style>
		.modal {
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0,0,0,0.4);
		}
		.modal-content {
			background-color: #fefefe;
			margin: 10% auto;
			padding: 0;
			border: 1px solid #888;
			width: 80%;
			max-width: 500px;
			border-radius: 8px;
			box-shadow: 0 4px 8px rgba(0,0,0,0.2);
		}
		.modal-header {
			padding: 15px 20px;
			background-color: #f8f9fa;
			border-bottom: 1px solid #dee2e6;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.modal-header h3 {
			margin: 0;
			color: #333;
		}
		.close {
			color: #aaa;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
		}
		.close:hover {
			color: #000;
		}
		.table-container {
			overflow-x: auto;
			max-height: 400px;
			overflow-y: auto;
		}
		.table th, .table td {
			padding: 8px 12px;
			text-align: left;
		}
		.table th {
			background-color: #f8f9fa;
			font-weight: 600;
		}
		.btn-small {
			padding: 4px 8px;
			font-size: 12px;
			margin-right: 4px;
		}
		.btn-danger {
			background-color: #dc3545;
			color: white;
		}
		.btn-danger:hover {
			background-color: #c82333;
		}
		.btn-warning {
			background-color: #ffc107;
			color: #212529;
		}
		.btn-warning:hover {
			background-color: #e0a800;
		}
	</style>
</head>
<body>
	<div class="admin-shell">
		<aside class="admin-sidebar">
			<div class="brand"><h1>TeleCRM Admin</h1></div>
			<nav>
				<a href="/admin/overview.html">Overview</a>
				<a href="/admin/users.html" class="active">Users</a>
				<a href="/admin/leads.html">Leads</a>
				<a href="/admin/call-records.html">Call Records</a>
				<a href="/admin/settings.html">Settings</a>
				<!-- <a href="/admin/mailbox.html">Mailbox</a> -->
			</nav>
		</aside>
		<main class="admin-main">
			<div class="admin-topbar">
					<h2 class="page-title">Users</h2>
					<div class="toolbar">
						<button class="btn btn-outline" onclick="toggleSidebar()">Toggle Sidebar</button>
						<input type="text" class="input" id="searchInput" placeholder="Search users..." style="margin-right: 8px;" />
						<select class="input" id="roleFilter" style="margin-right: 8px;">
							<option value="">All Roles</option>
							<option value="admin">Admin</option>
							<option value="manager">Manager</option>
							<option value="employee">Employee</option>
						</select>
						<button class="btn" id="refresh">Refresh</button>
						<button class="btn btn-primary" onclick="showCreateManagerModal()">Create Manager</button>
						<button class="btn btn-outline" id="themeToggle" title="Toggle Theme">Theme</button>
						<a class="btn btn-outline" href="/login.html" onclick="logout(event)">Logout</a>
					</div>
				</div>
			<div class="grid cols-2">
				<div class="card">
					<h3>Managers</h3>
					<div class="table-container">
						<table class="table" id="managersTbl">
							<thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
				<div class="card">
					<h3>Employees</h3>
					<div class="table-container">
						<table class="table" id="employeesTbl">
							<thead><tr><th>Name</th><th>Email</th><th>Manager</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="card">
				<h3 style="margin-top:0">Create Employee</h3>
				<form id="createEmployeeForm">
					<div class="grid cols-3">
						<div>
							<label>Name</label>
							<input class="input" id="ce_name" required />
						</div>
						<div>
							<label>Email</label>
							<input class="input" id="ce_email" type="email" required />
						</div>
						<div>
							<label>Password</label>
							<input class="input" id="ce_password" type="password" required />
						</div>
						<div>
							<label>Manager</label>
							<select class="input" id="ce_manager"></select>
						</div>
					</div>
					<div class="toolbar" style="margin-top:12px">
						<button class="btn" type="submit">Create</button>
					</div>
				</form>
			</div>

			<!-- Create Manager Modal -->
			<div id="createManagerModal" class="modal" style="display: none;">
				<div class="modal-content">
					<div class="modal-header">
						<h3>Create Manager</h3>
						<span class="close" onclick="closeCreateManagerModal()">&times;</span>
					</div>
					<form id="createManagerForm">
						<div>
							<label>Name</label>
							<input class="input" id="cm_name" required />
						</div>
						<div>
							<label>Email</label>
							<input class="input" id="cm_email" type="email" required />
						</div>
						<div>
							<label>Password</label>
							<input class="input" id="cm_password" type="password" required />
						</div>
						<div class="toolbar" style="margin-top:12px">
							<button class="btn" type="submit">Create Manager</button>
							<button class="btn btn-outline" type="button" onclick="closeCreateManagerModal()">Cancel</button>
						</div>
					</form>
				</div>
			</div>

			<!-- Edit User Modal -->
			<div id="editUserModal" class="modal" style="display: none;">
				<div class="modal-content">
					<div class="modal-header">
						<h3>Edit User</h3>
						<span class="close" onclick="closeEditUserModal()">&times;</span>
					</div>
					<form id="editUserForm">
						<input type="hidden" id="eu_id" />
						<div>
							<label>Name</label>
							<input class="input" id="eu_name" required />
						</div>
						<div>
							<label>Email</label>
							<input class="input" id="eu_email" type="email" required />
						</div>
						<div>
							<label>Role</label>
							<select class="input" id="eu_role" required>
								<option value="admin">Admin</option>
								<option value="manager">Manager</option>
								<option value="employee">Employee</option>
							</select>
						</div>
						<div id="managerField">
							<label>Manager</label>
							<select class="input" id="eu_manager"></select>
						</div>
						<div class="toolbar" style="margin-top:12px">
							<button class="btn" type="submit">Update User</button>
							<button class="btn btn-outline" type="button" onclick="closeEditUserModal()">Cancel</button>
						</div>
					</form>
				</div>
			</div>
		</main>
	</div>
	<script src="../assets/admin.js"></script>
	<script>
		let allUsers = { managers: [], employees: [] };
		let filteredUsers = { managers: [], employees: [] };

		Admin.navActivate('/admin/users.html');

		function toggleSidebar(){
			const sb = document.querySelector('.admin-sidebar');
			sb && sb.classList.toggle('open');
		}

		function logout(e){
			e && e.preventDefault();
			try {
				localStorage.removeItem('token');
				localStorage.removeItem('role');
			} catch(_){ }
			window.location.href = '/login.html';
		}

	       // Theme toggle
	       (function(){
	           const btn = document.getElementById('themeToggle');
	           if(btn){
	               btn.addEventListener('click', ()=>{
	                   const cur = localStorage.getItem('uiTheme') || 'light';
	                   const next = cur==='light' ? 'semi' : (cur==='semi' ? 'dark' : 'light');
	                   Admin.setTheme(next);
	               });
	           }
	       })();

		// Modal functions
		function showCreateManagerModal() {
			document.getElementById('createManagerModal').style.display = 'block';
			document.getElementById('cm_name').focus();
		}

		function closeCreateManagerModal() {
			document.getElementById('createManagerModal').style.display = 'none';
			document.getElementById('createManagerForm').reset();
		}

		function showEditUserModal(user) {
			document.getElementById('eu_id').value = user._id;
			document.getElementById('eu_name').value = user.name;
			document.getElementById('eu_email').value = user.email;
			document.getElementById('eu_role').value = user.role;

			// Show/hide manager field based on role
			const managerField = document.getElementById('managerField');
			if (user.role === 'employee') {
				managerField.style.display = 'block';
				populateManagerSelect();
			} else {
				managerField.style.display = 'none';
			}

			document.getElementById('editUserModal').style.display = 'block';
		}

		function closeEditUserModal() {
			document.getElementById('editUserModal').style.display = 'none';
			document.getElementById('editUserForm').reset();
		}

		function showDeleteConfirm(user) {
			if (confirm(`Are you sure you want to delete user "${user.name}"? This action cannot be undone.`)) {
				deleteUser(user._id);
			}
		}

		// Table row templates
		function rowUser(u){
			return `<tr>
				<td><strong>${u.name}</strong></td>
				<td>${u.email}</td>
				<td>${u.role}</td>
				<td>${Admin.fmtDate(u.createdAt)}</td>
				<td>
					<button class="btn btn-small btn-warning" onclick='showEditUserModal(${JSON.stringify(u)})'>Edit</button>
					<button class="btn btn-small btn-danger" onclick='showDeleteConfirm(${JSON.stringify(u)})'>Delete</button>
				</td>
			</tr>`;
		}

		function rowEmp(u){
			return `<tr>
				<td><strong>${u.name}</strong></td>
				<td>${u.email}</td>
				<td>${u.manager ? u.manager.name : '-'}</td>
				<td>${u.role}</td>
				<td>${Admin.fmtDate(u.createdAt)}</td>
				<td>
					<button class="btn btn-small btn-warning" onclick='showEditUserModal(${JSON.stringify(u)})'>Edit</button>
					<button class="btn btn-small btn-danger" onclick='showDeleteConfirm(${JSON.stringify(u)})'>Delete</button>
				</td>
			</tr>`;
		}

		// CRUD operations
		async function load(){
			try {
				const [managersRes, employeesRes] = await Promise.all([
					fetch('/api/admin/managers',{ headers: Admin.authHeaders() }),
					fetch('/api/admin/employees',{ headers: Admin.authHeaders() })
				]);

				if(managersRes.ok){
					allUsers.managers = await managersRes.json();
				} else {
					console.error('Failed to load managers:', await managersRes.text());
				}

				if(employeesRes.ok){
					allUsers.employees = await employeesRes.json();
				} else {
					console.error('Failed to load employees:', await employeesRes.text());
				}

				filterAndDisplayUsers();
			} catch (error) {
				console.error('Error loading users:', error);
				alert('Error loading users. Please try again.');
			}
		}

		function filterAndDisplayUsers() {
			const searchTerm = document.getElementById('searchInput').value.toLowerCase();
			const roleFilter = document.getElementById('roleFilter').value;

			filteredUsers.managers = allUsers.managers.filter(user =>
				(user.name.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm)) &&
				(!roleFilter || user.role === roleFilter)
			);

			filteredUsers.employees = allUsers.employees.filter(user =>
				(user.name.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm)) &&
				(!roleFilter || user.role === roleFilter)
			);

			document.querySelector('#managersTbl tbody').innerHTML = filteredUsers.managers.map(rowUser).join('');
			document.querySelector('#employeesTbl tbody').innerHTML = filteredUsers.employees.map(rowEmp).join('');
		}

		async function createEmployee(e){
			e.preventDefault();
			const payload = {
				name: document.getElementById('ce_name').value.trim(),
				email: document.getElementById('ce_email').value.trim(),
				password: document.getElementById('ce_password').value,
				managerId: document.getElementById('ce_manager').value || undefined
			};

			try {
				const res = await fetch('/api/admin/employees', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json', ...Admin.authHeaders() },
					body: JSON.stringify(payload)
				});

				if(res.ok){
					alert('Employee created successfully');
					document.getElementById('createEmployeeForm').reset();
					load();
				} else {
					const error = await res.json().catch(() => ({}));
					alert('Create failed: ' + (error.error || res.statusText));
				}
			} catch (error) {
				alert('Error creating employee. Please try again.');
			}
		}

		async function createManager(e){
			e.preventDefault();
			const payload = {
				name: document.getElementById('cm_name').value.trim(),
				email: document.getElementById('cm_email').value.trim(),
				password: document.getElementById('cm_password').value
			};

			try {
				const res = await fetch('/api/admin/managers', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json', ...Admin.authHeaders() },
					body: JSON.stringify(payload)
				});

				if(res.ok){
					alert('Manager created successfully');
					closeCreateManagerModal();
					load();
				} else {
					const error = await res.json().catch(() => ({}));
					alert('Create failed: ' + (error.error || res.statusText));
				}
			} catch (error) {
				alert('Error creating manager. Please try again.');
			}
		}

		async function updateUser(e){
			e.preventDefault();
			const userId = document.getElementById('eu_id').value;
			const payload = {
				name: document.getElementById('eu_name').value.trim(),
				email: document.getElementById('eu_email').value.trim(),
				role: document.getElementById('eu_role').value,
				manager: document.getElementById('eu_role').value === 'employee' ?
					document.getElementById('eu_manager').value || undefined : undefined
			};

			try {
				const res = await fetch(`/api/admin/users/${userId}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json', ...Admin.authHeaders() },
					body: JSON.stringify(payload)
				});

				if(res.ok){
					alert('User updated successfully');
					closeEditUserModal();
					load();
				} else {
					const error = await res.json().catch(() => ({}));
					alert('Update failed: ' + (error.error || res.statusText));
				}
			} catch (error) {
				alert('Error updating user. Please try again.');
			}
		}

		async function deleteUser(userId){
			try {
				const res = await fetch(`/api/admin/users/${userId}`, {
					method: 'DELETE',
					headers: Admin.authHeaders()
				});

				if(res.ok){
					alert('User deleted successfully');
					load();
				} else {
					const error = await res.json().catch(() => ({}));
					alert('Delete failed: ' + (error.error || res.statusText));
				}
			} catch (error) {
				alert('Error deleting user. Please try again.');
			}
		}

		async function populateManagers(){
			try {
				const res = await fetch('/api/admin/managers',{ headers: Admin.authHeaders() });
				if(!res.ok) return;

				const managers = await res.json();
				const options = '<option value="">-- None --</option>' + managers.map(m => `<option value="${m._id}">${m.name}</option>`).join('');

				document.getElementById('ce_manager').innerHTML = options;
				document.getElementById('eu_manager').innerHTML = options;
			} catch (error) {
				console.error('Error loading managers:', error);
			}
		}

		// Event listeners
		document.getElementById('refresh').addEventListener('click', load);
		document.getElementById('createEmployeeForm').addEventListener('submit', createEmployee);
		document.getElementById('createManagerForm').addEventListener('submit', createManager);
		document.getElementById('editUserForm').addEventListener('submit', updateUser);

		document.getElementById('searchInput').addEventListener('input', filterAndDisplayUsers);
		document.getElementById('roleFilter').addEventListener('change', filterAndDisplayUsers);

		document.getElementById('eu_role').addEventListener('change', function(){
			const managerField = document.getElementById('managerField');
			if (this.value === 'employee') {
				managerField.style.display = 'block';
			} else {
				managerField.style.display = 'none';
			}
		});

		// Close modal when clicking outside
		window.onclick = function(event) {
			const createModal = document.getElementById('createManagerModal');
			const editModal = document.getElementById('editUserModal');
			if (event.target === createModal) {
				closeCreateManagerModal();
			}
			if (event.target === editModal) {
				closeEditUserModal();
			}
		}

		// Initialize
		if(Admin.getToken()){
			Admin.applyTheme();
			load();
			populateManagers();
		}
	</script>
</body>
</html>


