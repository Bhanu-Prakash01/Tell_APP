<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads Database - Telecalling Application</title>
    <link rel="stylesheet" href="/css/frappe.css">
    <style>
        .leads-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .leads-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--frappe-text);
            margin: 0;
        }

        .leads-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filters-section {
            background: var(--frappe-white);
            border: 1px solid var(--frappe-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--frappe-shadow);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .search-box {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--frappe-text-muted);
            font-size: 1.1rem;
        }

        .search-input {
            padding-left: 3rem;
            width: 100%;
        }

        .leads-table-section {
            background: var(--frappe-white);
            border: 1px solid var(--frappe-border);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--frappe-shadow);
        }

        .table-header {
            background: var(--frappe-gray-50);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--frappe-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--frappe-text);
            margin: 0;
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            padding: 1rem;
        }

        .pagination-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            color: var(--frappe-text-muted);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--frappe-border);
            background: var(--frappe-white);
            color: var(--frappe-text);
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            cursor: pointer;
            min-width: 2.5rem;
            text-align: center;
        }

        .pagination-btn:hover:not(.disabled) {
            background: var(--frappe-gray-100);
            border-color: var(--frappe-primary);
        }

        .pagination-btn.active {
            background: var(--frappe-primary);
            color: var(--frappe-white);
            border-color: var(--frappe-primary);
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--frappe-gray-50);
        }

        .pagination-btn.prev-next {
            font-weight: 500;
        }

        .pagination-ellipsis {
            padding: 0.5rem;
            color: var(--frappe-text-muted);
        }

        .page-size-selector {
            margin-left: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-size-selector select {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--frappe-border);
            border-radius: 4px;
            background: var(--frappe-white);
            font-size: 0.9rem;
        }

        .leads-count {
            background: var(--frappe-gray-100);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--frappe-text-muted);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--frappe-text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .lead-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .status-new { background: rgba(36, 144, 239, 0.1); color: var(--frappe-primary); }
        .status-contacted { background: rgba(243, 156, 18, 0.1); color: var(--frappe-warning); }
        .status-qualified { background: rgba(19, 194, 150, 0.1); color: var(--frappe-success); }
        .status-converted { background: rgba(19, 194, 150, 0.1); color: var(--frappe-success); }
        .status-closed { background: rgba(244, 67, 54, 0.1); color: var(--frappe-danger); }

        @media (max-width: 768px) {
            .leads-header {
                flex-direction: column;
                align-items: stretch;
            }

            .leads-actions {
                justify-content: space-between;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .pagination {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Header -->
        <header class="admin-header">
            <nav class="admin-nav">
                <a href="/admin/dashboard" class="nav-brand">Telecalling Admin</a>
                <ul class="nav-menu">
                    <li><a href="/admin/dashboard" class="nav-link">Dashboard</a></li>
                    <li><a href="/admin/leads" class="nav-link active">Leads</a></li>
                    <li><a href="/admin/lead-assignment" class="nav-link">Auto Assignment</a></li>
                    <li><a href="/admin/user-management" class="nav-link">Users</a></li>
                    <li><button class="btn btn-secondary" data-action="logout">Logout</button></li>
                </ul>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Leads Header -->
            <div class="leads-header">
                <h1 class="leads-title">Leads Database</h1>
                <div class="leads-actions">
                    <button class="btn btn-primary" onclick="adminApp.loadLeadsData()">
                        <span class="loading" style="margin-right: 0.5rem;"></span>
                        Refresh
                    </button>
                    <button class="btn btn-success" onclick="exportLeads()">
                        üì• Export
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="filters-section">
                <form id="leadsFilters">
                    <div class="filters-grid">
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input
                                type="text"
                                id="leadsSearch"
                                name="search"
                                class="form-control search-input"
                                placeholder="Search leads by name, phone, description, or website..."
                            >
                        </div>

                        <div>
                            <label for="statusFilter" class="form-label">Status</label>
                            <select id="statusFilter" name="status" class="form-control">
                                <option value="">All Statuses</option>
                                <option value="New">New</option>
                                <option value="Interested">Interested</option>
                                <option value="Not Interested">Not Interested</option>
                                <option value="Hot">Hot</option>
                                <option value="Pending">Pending</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>

                        <div>
                            <label for="assignedToFilter" class="form-label">Assigned To</label>
                            <select id="assignedToFilter" name="assignedTo" class="form-control">
                                <option value="">All Employees</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>

                        <div>
                            <label for="sectorFilter" class="form-label">Sector</label>
                            <select id="sectorFilter" name="sector" class="form-control">
                                <option value="">All Sectors</option>
                                <option value="technology">Technology</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="finance">Finance</option>
                                <option value="education">Education</option>
                                <option value="retail">Retail</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div>
                            <button type="submit" class="btn btn-primary">
                                üîç Filter
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                                üóëÔ∏è Clear
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Leads Table -->
            <div class="leads-table-section">
                <div class="table-header">
                    <h2 class="table-title">All Leads</h2>
                    <div class="table-actions">
                        <span class="leads-count" id="leadsCount">Loading...</span>
                    </div>
                </div>

                <!-- Bulk Operations Bar -->
                <div class="bulk-operations-bar" id="bulkOperationsBar" style="display: none;">
                    <div class="bulk-info">
                        <span id="selectedCount">0</span> leads selected
                    </div>
                    <div class="bulk-actions">
                        <button class="btn btn-sm btn-danger" id="bulkDeleteBtn" onclick="bulkDeleteLeads()">
                            üóëÔ∏è Delete Selected
                        </button>
                        <button class="btn btn-sm btn-secondary" id="clearSelectionBtn" onclick="clearLeadSelection()">
                            Clear Selection
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table" id="leadsTable">
                        <thead>
                            <tr>
                                <th class="select-all-header">
                                    <input type="checkbox" id="selectAllLeads" onclick="toggleSelectAll()">
                                </th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Description</th>
                                <th>Website</th>
                                <th>Notes</th>
                                <th>Status</th>
                                <th>Call Time</th>
                                <th>Assigned To</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="11">
                                    <div class="empty-state">
                                        <div class="loading"></div>
                                        <p>Loading leads...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="leadsPagination">
                    <div class="pagination-info">
                        <span id="paginationInfo">Showing 0-0 of 0 leads</span>
                        <div class="page-size-selector">
                            <label for="pageSize">Show:</label>
                            <select id="pageSize" onchange="changePageSize()">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    <div class="pagination-controls" id="paginationControls">
                        <!-- Pagination buttons will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Lead Details Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Lead Details</h3>
                <button class="modal-close" onclick="hideModal('leadModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="leadDetails">
                    <!-- Lead details will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('leadModal')">Close</button>
                <button class="btn btn-primary" onclick="saveLeadChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" style="display: none;">
        <div class="spinner">
            <div class="loading"></div>
            <span>Loading leads...</span>
        </div>
    </div>

    <script src="/js/admin.js"></script>
    <script>
        // Leads page-specific functionality
        function initializeLeadsPage() {
            // Load employees for filter dropdown
            loadEmployeesForFilter();

            // Initialize leads data
            if (window.adminApp && window.adminApp.loadLeadsData) {
                window.adminApp.loadLeadsData();
            }
        }

        async function loadEmployeesForFilter() {
            if (!window.adminApp) return;

            try {
                const employeesResponse = await window.adminApp.apiRequest('/employees');
                const select = document.getElementById('assignedToFilter');

                // Handle API response format - extract employees array from response
                let employeesArray = [];
                if (Array.isArray(employeesResponse)) {
                    employeesArray = employeesResponse;
                } else if (employeesResponse && employeesResponse.data && Array.isArray(employeesResponse.data.employees)) {
                    employeesArray = employeesResponse.data.employees;
                } else if (employeesResponse && employeesResponse.data && Array.isArray(employeesResponse.data)) {
                    employeesArray = employeesResponse.data;
                }

                employeesArray.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee._id || employee.id;
                    option.textContent = employee.name || 'N/A';
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        function clearFilters() {
            document.getElementById('leadsFilters').reset();
            document.getElementById('leadsSearch').value = '';
            if (window.adminApp && window.adminApp.loadLeadsData) {
                window.adminApp.loadLeadsData();
            }
        }

        function exportLeads() {
            // Get current filter values
            const form = document.getElementById('leadsFilters');
            const formData = new FormData(form);
            const filters = Object.fromEntries(formData.entries());
            filters.search = document.getElementById('leadsSearch').value;

            // Create export URL with filters
            const params = new URLSearchParams(filters);
            window.open(`/api/admin/leads/export?${params}`, '_blank');
        }

        // Pagination state management
        let paginationState = {
            currentPage: 1,
            pageSize: 25,
            totalItems: 0,
            totalPages: 0,
            allLeads: []
        };

        // Override the renderLeadsTable function to include pagination
        function setupLeadsOverrides() {
            if (!window.adminApp) return;

            const originalRenderLeadsTable = window.adminApp.renderLeadsTable;
            window.adminApp.renderLeadsTable = function(leads) {
                // Store all leads for pagination
                paginationState.allLeads = leads;
                paginationState.totalItems = leads.length;
                paginationState.totalPages = Math.ceil(leads.length / paginationState.pageSize);

                // Render current page data
                this.renderPaginatedLeadsTable(leads);

                // Update leads count and pagination info
                this.updatePaginationInfo();
                this.updatePaginationControls();
            };

            // New method for paginated table rendering
            window.adminApp.renderPaginatedLeadsTable = function(allLeads) {
                // Handle API response format - extract leads array from response
                let leadsArray = [];
                if (Array.isArray(allLeads)) {
                    leadsArray = allLeads;
                } else if (allLeads && allLeads.data && Array.isArray(allLeads.data.leads)) {
                    leadsArray = allLeads.data.leads;
                } else if (allLeads && allLeads.data && Array.isArray(allLeads.data)) {
                    leadsArray = allLeads.data;
                }

                // Update pagination state
                paginationState.allLeads = leadsArray;
                paginationState.totalItems = leadsArray.length;
                paginationState.totalPages = Math.ceil(leadsArray.length / paginationState.pageSize);

                const startIndex = (paginationState.currentPage - 1) * paginationState.pageSize;
                const endIndex = startIndex + paginationState.pageSize;
                const currentPageLeads = leadsArray.slice(startIndex, endIndex);

                const leadsTable = document.querySelector('#leadsTable');
                if (!leadsTable) return;

                const tbody = leadsTable.querySelector('tbody');
                if (!tbody) return;

                if (currentPageLeads.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="11">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üìã</div>
                                    <p>No leads found</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = currentPageLeads.map(lead => `
                    <tr>
                        <td><input type="checkbox" class="lead-checkbox" value="${lead._id || lead.id}" onclick="toggleLeadSelection('${lead._id || lead.id}')"></td>
                        <td>${lead.name || 'N/A'}</td>
                        <td>${lead.phone || 'N/A'}</td>
                        <td>${lead.description || 'N/A'}</td>
                        <td>${lead.website ? `<a href="${lead.website}" target="_blank" rel="noopener noreferrer">${lead.website}</a>` : 'N/A'}</td>
                        <td>${lead.notes || 'N/A'}</td>
                        <td><span class="badge badge-${this.getStatusBadgeClass(lead.status)}">${lead.status || 'New'}</span></td>
                        <td>${lead.callTime ? (typeof window.formatCallTime === 'function' ? window.formatCallTime(lead.callTime) : lead.callTime) : 'Not recorded'}</td>
                        <td>${lead.assignedTo || 'Unassigned'}</td>
                        <td>${new Date(lead.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="adminApp.editLead('${lead._id || lead.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="adminApp.deleteLead('${lead._id || lead.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            };

            window.adminApp.updatePaginationInfo = function() {
                // Ensure pagination state has valid values
                if (!paginationState.totalItems || paginationState.totalItems === 0) {
                    const paginationInfo = document.getElementById('paginationInfo');
                    if (paginationInfo) {
                        paginationInfo.textContent = 'No leads to display';
                    }

                    const leadsCountElement = document.getElementById('leadsCount');
                    if (leadsCountElement) {
                        leadsCountElement.textContent = '0 leads';
                    }
                    return;
                }

                const startItem = (paginationState.currentPage - 1) * paginationState.pageSize + 1;
                const endItem = Math.min(paginationState.currentPage * paginationState.pageSize, paginationState.totalItems);

                const paginationInfo = document.getElementById('paginationInfo');
                if (paginationInfo) {
                    paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${paginationState.totalItems} leads`;
                }

                const leadsCountElement = document.getElementById('leadsCount');
                if (leadsCountElement) {
                    leadsCountElement.textContent = `${paginationState.totalItems} leads`;
                }
            };

            window.adminApp.updatePaginationControls = function() {
                const paginationControls = document.getElementById('paginationControls');
                if (!paginationControls) return;

                // Don't show pagination controls if no data
                if (!paginationState.totalItems || paginationState.totalItems === 0) {
                    paginationControls.innerHTML = '';
                    return;
                }

                let controlsHTML = '';

                if (paginationState.totalPages > 1) {
                    // Previous button
                    controlsHTML += `<button class="pagination-btn prev-next" onclick="changePage(${paginationState.currentPage - 1})" ${paginationState.currentPage === 1 ? 'disabled' : ''}>‚Üê Previous</button>`;

                    // Page number buttons
                    const startPage = Math.max(1, paginationState.currentPage - 2);
                    const endPage = Math.min(paginationState.totalPages, paginationState.currentPage + 2);

                    // First page if not in range
                    if (startPage > 1) {
                        controlsHTML += `<button class="pagination-btn" onclick="changePage(1)">1</button>`;
                        if (startPage > 2) {
                            controlsHTML += `<span class="pagination-ellipsis">...</span>`;
                        }
                    }

                    // Page range
                    for (let i = startPage; i <= endPage; i++) {
                        controlsHTML += `<button class="pagination-btn ${i === paginationState.currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                    }

                    // Last page if not in range
                    if (endPage < paginationState.totalPages) {
                        if (endPage < paginationState.totalPages - 1) {
                            controlsHTML += `<span class="pagination-ellipsis">...</span>`;
                        }
                        controlsHTML += `<button class="pagination-btn" onclick="changePage(${paginationState.totalPages})">${paginationState.totalPages}</button>`;
                    }

                    // Next button
                    controlsHTML += `<button class="pagination-btn prev-next" onclick="changePage(${paginationState.currentPage + 1})" ${paginationState.currentPage === paginationState.totalPages ? 'disabled' : ''}>Next ‚Üí</button>`;
                }

                paginationControls.innerHTML = controlsHTML;
            };

            // Enhanced lead actions
            window.adminApp.editLead = function(leadId) {
                // Show lead details modal
                this.showModal('leadModal');
                // Load lead details and populate form
                loadLeadDetails(leadId);
            };

            window.adminApp.deleteLead = function(leadId) {
                if (confirm('Are you sure you want to delete this lead?')) {
                    // Implement delete functionality
                    this.apiRequest(`/leads/${leadId}`, { method: 'DELETE' })
                        .then(() => {
                            this.showToast('Lead deleted successfully', 'success');
                            this.loadLeadsData();
                        })
                        .catch(error => {
                            this.showToast('Failed to delete lead', 'error');
                        });
                }
            };
        }

        function changePage(page) {
            if (page < 1 || page > paginationState.totalPages) return;

            paginationState.currentPage = page;

            // Re-render table with new page data
            if (window.adminApp && window.adminApp.renderPaginatedLeadsTable) {
                window.adminApp.renderPaginatedLeadsTable(paginationState.allLeads);
                window.adminApp.updatePaginationInfo();
                window.adminApp.updatePaginationControls();
            }
        }

        function changePageSize() {
            const pageSizeSelect = document.getElementById('pageSize');
            const newPageSize = parseInt(pageSizeSelect.value);

            paginationState.pageSize = newPageSize;
            paginationState.currentPage = 1; // Reset to first page
            paginationState.totalPages = Math.ceil(paginationState.totalItems / newPageSize);

            // Re-render table with new page size
            if (window.adminApp && window.adminApp.renderPaginatedLeadsTable) {
                window.adminApp.renderPaginatedLeadsTable(paginationState.allLeads);
                window.adminApp.updatePaginationInfo();
                window.adminApp.updatePaginationControls();
            }
        }

        function goToFirstPage() {
            changePage(1);
        }

        function goToLastPage() {
            changePage(paginationState.totalPages);
        }

        function goToNextPage() {
            changePage(paginationState.currentPage + 1);
        }

        function goToPreviousPage() {
            changePage(paginationState.currentPage - 1);
        }

        async function loadLeadDetails(leadId) {
            if (!window.adminApp) return;

            try {
                const lead = await window.adminApp.apiRequest(`/leads/${leadId}`);
                const detailsContainer = document.getElementById('leadDetails');

                if (detailsContainer) {
                    detailsContainer.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" value="${lead.name || ''}" id="editLeadName">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" value="${lead.email || ''}" id="editLeadEmail">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" value="${lead.phone || ''}" id="editLeadPhone">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company</label>
                            <input type="text" class="form-control" value="${lead.company || ''}" id="editLeadCompany">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-control" id="editLeadStatus">
                                <option value="New" ${lead.status === 'New' ? 'selected' : ''}>New</option>
                                <option value="Interested" ${lead.status === 'Interested' ? 'selected' : ''}>Interested</option>
                                <option value="Not Interested" ${lead.status === 'Not Interested' ? 'selected' : ''}>Not Interested</option>
                                <option value="Hot" ${lead.status === 'Hot' ? 'selected' : ''}>Hot</option>
                                <option value="Pending" ${lead.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Completed" ${lead.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading lead details:', error);
            }
        }

        function saveLeadChanges() {
            if (!window.adminApp) return;

            // Implement save functionality
            const leadId = document.getElementById('editLeadId')?.value;
            if (leadId) {
                const updatedLead = {
                    name: document.getElementById('editLeadName').value,
                    email: document.getElementById('editLeadEmail').value,
                    phone: document.getElementById('editLeadPhone').value,
                    company: document.getElementById('editLeadCompany').value,
                    status: document.getElementById('editLeadStatus').value,
                };

                window.adminApp.apiRequest(`/leads/${leadId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedLead),
                })
                .then(() => {
                    window.adminApp.showToast('Lead updated successfully', 'success');
                    if (window.hideModal) hideModal('leadModal');
                    window.adminApp.loadLeadsData();
                })
                .catch(error => {
                    window.adminApp.showToast('Failed to update lead', 'error');
                });
            }
        }

        // Global utility functions
        window.formatCallTime = function(callTime) {
            if (!callTime) return 'Not recorded';

            // If it's already in time format (HH:MM), return as is
            if (/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(callTime)) {
                return callTime;
            }

            // If it's in duration format, convert to readable format
            const hours = callTime.match(/(\d+)h/);
            const minutes = callTime.match(/(\d+)m/);
            const seconds = callTime.match(/(\d+)s/);

            let totalSeconds = 0;
            if (hours) totalSeconds += parseInt(hours[1]) * 3600;
            if (minutes) totalSeconds += parseInt(minutes[1]) * 60;
            if (seconds) totalSeconds += parseInt(seconds[1]);

            if (totalSeconds === 0) return callTime;

            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;

            let result = '';
            if (h > 0) result += `${h}h `;
            if (m > 0) result += `${m}m `;
            if (s > 0 || result === '') result += `${s}s`;

            return result.trim();
        };

        // Wait for adminApp to be available
        function checkAdminApp() {
            if (typeof window.adminApp !== 'undefined') {
                initializeLeadsPage();
                setupLeadsOverrides();
            } else {
                setTimeout(checkAdminApp, 100);
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkAdminApp);
        } else {
            checkAdminApp();
        }
    </script>
</body>
</html>